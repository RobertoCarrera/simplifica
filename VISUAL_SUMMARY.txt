
╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║        🎯 EDGE FUNCTION HIDE-STAGE: SOLUCIÓN COMPLETA                       ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────┐
│ 📊 PROBLEMA ORIGINAL                                                         │
└──────────────────────────────────────────────────────────────────────────────┘

   Angular Service
        │
        ├─► supabase.from('hidden_stages').insert()
        │
        └─► ❌ ERROR 403 FORBIDDEN
            │
            └─► "new row violates row-level security policy"
                (RLS con subconsulta compleja en WITH CHECK fallaba)


┌──────────────────────────────────────────────────────────────────────────────┐
│ ✅ SOLUCIÓN IMPLEMENTADA                                                     │
└──────────────────────────────────────────────────────────────────────────────┘

   Angular Service
        │
        ├─► fetch('/functions/v1/hide-stage', { JWT })
        │
        ├─► Edge Function (Deno + Supabase)
        │    │
        │    ├─► 1. Validar JWT ✓
        │    ├─► 2. Obtener company_id del user ✓
        │    ├─► 3. Verificar stage.company_id IS NULL ✓
        │    ├─► 4. INSERT/DELETE con service_role ✓
        │    │
        │    └─► ✅ SUCCESS (bypass RLS seguro)
        │
        └─► return { result: {...} }


┌──────────────────────────────────────────────────────────────────────────────┐
│ 📁 ARCHIVOS CREADOS                                                          │
└──────────────────────────────────────────────────────────────────────────────┘

   ✨ Edge Function
   ├─► supabase/functions/hide-stage/index.ts          (380 líneas, completa)
   └─► supabase/functions/hide-stage/README.md         (Documentación técnica)

   📜 Scripts de Deployment
   ├─► deploy-hide-stage.sh                            (Deployment automatizado)
   └─► quick-deploy.sh                                 (Deployment en 5 minutos)

   📚 Documentación
   ├─► EDGE_FUNCTION_DEPLOYMENT_GUIDE.md               (Guía paso a paso)
   ├─► EDGE_FUNCTION_SOLUTION_SUMMARY.md               (Resumen ejecutivo)
   └─► VISUAL_SUMMARY.txt                              (Este archivo)

   🗄️ Migraciones SQL
   └─► supabase/migrations/update_rls_for_edge_function.sql (Limpieza RLS)

   🔧 Código Angular modificado
   └─► src/app/services/supabase-ticket-stages.service.ts
        ├─► hideGenericStage() → Ahora usa Edge Function
        └─► unhideGenericStage() → Ahora usa Edge Function


┌──────────────────────────────────────────────────────────────────────────────┐
│ 🚀 DEPLOYMENT EN 3 PASOS                                                     │
└──────────────────────────────────────────────────────────────────────────────┘

   1️⃣  DESPLEGAR FUNCIÓN
       
       bash quick-deploy.sh
       
       O manualmente:
       supabase functions deploy hide-stage --project-ref ufutyjbqfjrlzkprvyvs


   2️⃣  CONFIGURAR ENV VARS (en Dashboard)
       
       https://supabase.com/dashboard/project/ufutyjbqfjrlzkprvyvs/settings/functions
       
       Variables requeridas:
       ┌────────────────────────────────────────────────────────────────────┐
       │ SUPABASE_URL              = https://ufutyjbqfjrlzkprvyvs.supabase.co │
       │ SUPABASE_SERVICE_ROLE_KEY = <desde Project Settings > API>        │
       │ ALLOW_ALL_ORIGINS         = true                                   │
       └────────────────────────────────────────────────────────────────────┘


   3️⃣  PROBAR
       
       # Ver logs
       supabase functions logs hide-stage --follow
       
       # Test OPTIONS
       curl -X OPTIONS https://ufutyjbqfjrlzkprvyvs.supabase.co/functions/v1/hide-stage \
            -H "Origin: http://localhost:4200" -v
       
       # Test desde UI
       http://localhost:4200/configuracion/estados
       Click "Ocultar" → ✅ Debe funcionar sin 403


┌──────────────────────────────────────────────────────────────────────────────┐
│ 🔐 SEGURIDAD                                                                 │
└──────────────────────────────────────────────────────────────────────────────┘

   ✅ Service Role Key solo en servidor (Edge Function)
   ✅ JWT validado en cada request
   ✅ company_id obtenido del usuario autenticado (no del body)
   ✅ Validación de stage genérico antes de insert
   ✅ RLS simplificado (solo verifica ownership)
   ✅ CORS configurado y validado


┌──────────────────────────────────────────────────────────────────────────────┐
│ 📊 ANTES vs DESPUÉS                                                          │
└──────────────────────────────────────────────────────────────────────────────┘

   ┌────────────────────┬──────────────────────┬────────────────────────────┐
   │ Aspecto            │ Antes (RLS directo)  │ Después (Edge Function)    │
   ├────────────────────┼──────────────────────┼────────────────────────────┤
   │ Error 403          │ ❌ Sí                │ ✅ No                      │
   │ Validación         │ RLS complejo         │ Edge Function claro        │
   │ Mensajes error     │ Crípticos            │ Descriptivos con detalles  │
   │ Debugging          │ Imposible            │ Logs en tiempo real        │
   │ Mantenibilidad     │ Baja                 │ Alta                       │
   │ Performance        │ Subconsultas         │ Validación directa         │
   │ Idempotencia       │ No                   │ Sí                         │
   └────────────────────┴──────────────────────┴────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────────┐
│ 🧪 TESTS DE VALIDACIÓN                                                       │
└──────────────────────────────────────────────────────────────────────────────┘

   ✅ Test 1: OPTIONS preflight CORS
      → curl -X OPTIONS [...] 
      → Esperado: 200 OK

   ✅ Test 2: POST sin Authorization
      → curl -X POST [...] (sin header Auth)
      → Esperado: 401 {"error":"Missing or invalid authorization"}

   ✅ Test 3: Hide stage genérico
      → Body: {"p_stage_id":"uuid","p_operation":"hide"}
      → Esperado: 200 {"result":{...}}

   ✅ Test 4: Hide stage NO genérico (debe fallar)
      → Body: {"p_stage_id":"uuid-empresa","p_operation":"hide"}
      → Esperado: 400 {"error":"Only generic stages can be hidden"}

   ✅ Test 5: Unhide stage
      → Body: {"p_stage_id":"uuid","p_operation":"unhide"}
      → Esperado: 200 {"result":{...}}

   ✅ Test 6: End-to-end desde UI
      → Configuración > Gestionar Estados
      → Click "Ocultar" en estado genérico
      → Debe funcionar, mostrar badge "Oculto", reducir opacidad
      → Click "Mostrar" debe revertir


┌──────────────────────────────────────────────────────────────────────────────┐
│ 📈 LOGS Y MONITOREO                                                          │
└──────────────────────────────────────────────────────────────────────────────┘

   Ver logs en tiempo real:
   
   supabase functions logs hide-stage --project-ref ufutyjbqfjrlzkprvyvs --follow

   Logs generados:
   
   ✅ Authenticated user: uuid-123
   ✅ User company_id: uuid-456
   🔄 Processing hide for stage uuid-789
   ✅ Stage "Pendiente" is generic
   ✅ Stage hidden successfully


┌──────────────────────────────────────────────────────────────────────────────┐
│ 🎯 CHECKLIST FINAL                                                           │
└──────────────────────────────────────────────────────────────────────────────┘

   [✅] Edge Function creada (index.ts)
   [✅] Servicio Angular actualizado
   [✅] Documentación completa
   [✅] Scripts de deployment
   [✅] Migración SQL preparada
   [ ] Desplegar Edge Function          ← SIGUIENTE PASO
   [ ] Configurar variables entorno
   [ ] Probar con curl
   [ ] Probar end-to-end desde UI
   [ ] Verificar logs


┌──────────────────────────────────────────────────────────────────────────────┐
│ 🆘 TROUBLESHOOTING RÁPIDO                                                    │
└──────────────────────────────────────────────────────────────────────────────┘

   ❌ "Function not found"
      → Verificar deployment: supabase functions list
      → Re-desplegar: bash deploy-hide-stage.sh

   ❌ "Missing SUPABASE_SERVICE_ROLE_KEY"
      → Configurar env vars en Dashboard
      → Project Settings > API > service_role key

   ❌ Error 401 en tests
      → Token JWT expirado o inválido
      → Obtener nuevo token de localStorage

   ❌ "Origin not allowed"
      → Configurar ALLOW_ALL_ORIGINS=true
      → O añadir dominio específico en ALLOWED_ORIGINS

   ❌ Logs no aparecen
      → Esperar 30 segundos después de deployment
      → Verificar que función se llamó al menos una vez


┌──────────────────────────────────────────────────────────────────────────────┐
│ 📚 DOCUMENTACIÓN DE REFERENCIA                                               │
└──────────────────────────────────────────────────────────────────────────────┘

   📖 Guía de deployment completa
      → EDGE_FUNCTION_DEPLOYMENT_GUIDE.md

   📖 Resumen ejecutivo
      → EDGE_FUNCTION_SOLUTION_SUMMARY.md

   📖 Documentación técnica Edge Function
      → supabase/functions/hide-stage/README.md

   📖 Patrón maestro
      → crear-Edge-Function-correctamente.txt


┌──────────────────────────────────────────────────────────────────────────────┐
│ 🎉 RESULTADO ESPERADO                                                        │
└──────────────────────────────────────────────────────────────────────────────┘

   ✅ Usuario puede ocultar estados genéricos que no usa
   ✅ Usuario puede mostrar estados previamente ocultos
   ✅ Estados ocultos se muestran con badge "Oculto"
   ✅ Estados ocultos tienen opacidad reducida
   ✅ No más errores 403
   ✅ Mensajes de error claros y útiles
   ✅ Logs en tiempo real para debugging
   ✅ Sistema seguro multi-tenant
   ✅ Código mantenible y escalable


╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║                  🚀 SIGUIENTE ACCIÓN INMEDIATA                               ║
║                                                                              ║
║                      bash quick-deploy.sh                                    ║
║                                                                              ║
║                  (Deployment completo en 5 minutos)                          ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝


════════════════════════════════════════════════════════════════════════════════
Creado: 2025-10-17
Versión: 1.0.0
Estado: ✅ Lista para deployment
Patrón: Edge Function + Service Role + Validación en servidor
════════════════════════════════════════════════════════════════════════════════

# AN√ÅLISIS DE POL√çTICAS RLS DUPLICADAS

## üìä Resumen Ejecutivo

**Estado**: ‚ÑπÔ∏è **INFORMATIVO - NO CR√çTICO**  
**Warnings**: 156 de 192 (81% del total)  
**Impacto en Seguridad**: ‚úÖ **NINGUNO** (pol√≠ticas duplicadas son redundantes pero seguras)  
**Impacto en Rendimiento**: ‚ö†Ô∏è **MENOR** (eval√∫a 2 pol√≠ticas en lugar de 1)  
**Prioridad de Correcci√≥n**: üîµ **BAJA** (puede esperar a fase de limpieza)

---

## üîç ¬øPor qu√© existen pol√≠ticas duplicadas?

Durante la implementaci√≥n de RLS, se crearon **nuevas pol√≠ticas modernas** sin eliminar las **antiguas pol√≠ticas legacy**. PostgreSQL permite m√∫ltiples pol√≠ticas permisivas para la misma acci√≥n, evalu√°ndolas con **OR l√≥gico**.

**Ejemplo en tabla `addresses`**:
- ‚úÖ **Nueva pol√≠tica**: `addresses_own_user_only` (pol√≠tica moderna, naming consistente)
- ‚ö†Ô∏è **Pol√≠tica legacy**: `Users can delete own addresses` (pol√≠tica antigua, naming descriptivo)

**Resultado**: Ambas permiten el acceso correcto, pero PostgreSQL debe evaluar ambas.

---

## üìã Tablas Afectadas y Pol√≠ticas Duplicadas

### 1. **addresses** (8 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT, INSERT, UPDATE, DELETE

**Pol√≠ticas duplicadas**:
- `Users can view own addresses` + `addresses_own_user_only`
- `Users can insert own addresses` + `addresses_own_user_only`
- `Users can update own addresses` + `addresses_own_user_only`
- `Users can delete own addresses` + `addresses_own_user_only`

**Recomendaci√≥n**: Eliminar las 4 pol√≠ticas legacy con nombre `Users can...`, mantener `addresses_own_user_only`.

---

### 2. **companies** (16 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT, UPDATE, INSERT, DELETE

**Pol√≠ticas duplicadas**:
- `companies_own_view` + `companies_own_only` (SELECT)
- `companies_owner_edit` + `companies_own_only` (UPDATE)
- `allow_all_for_companies` + `companies_own_only` (INSERT, DELETE en authenticated)

**Recomendaci√≥n**: 
- Mantener `companies_own_only` (pol√≠tica moderna, cubre todos los casos)
- Eliminar `companies_own_view`, `companies_owner_edit`, `allow_all_for_companies`

---

### 3. **company_invitations** (12 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT, INSERT, UPDATE

**Pol√≠ticas duplicadas**:
- `Company members can view invitations` + `company_invitations_company_only`
- `Owners and admins can create invitations` + `company_invitations_company_only`
- `Inviter can update invitations` + `company_invitations_company_only`

**Recomendaci√≥n**: Mantener `company_invitations_company_only`, eliminar las 3 legacy.

---

### 4. **devices** (4 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT

**Pol√≠ticas duplicadas**:
- `devices_gdpr_company_access` + `devices_company_only`

**Recomendaci√≥n**: Mantener ambas (tienen l√≥gica diferente):
- `devices_company_only`: Filtro b√°sico por company_id
- `devices_gdpr_company_access`: A√±ade filtro GDPR (excluye clientes anonimizados)

**Soluci√≥n mejor**: Fusionar en una sola pol√≠tica con ambos filtros.

---

### 5. **gdpr_access_requests** (16 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT, INSERT, UPDATE, DELETE

**Pol√≠ticas duplicadas**:
- `gdpr_access_requests_company` + `gdpr_access_requests_company_only`

**Recomendaci√≥n**: Mantener `gdpr_access_requests_company_only`, eliminar `gdpr_access_requests_company`.

---

### 6. **gdpr_audit_log** (4 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT

**Pol√≠ticas duplicadas**:
- `gdpr_audit_log_access` + `gdpr_audit_log_company_only`

**Recomendaci√≥n**: Mantener `gdpr_audit_log_access` (filtro por DPO/admin), eliminar `gdpr_audit_log_company_only`.

---

### 7. **gdpr_breach_incidents** (16 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT, INSERT, UPDATE, DELETE

**Pol√≠ticas duplicadas**:
- `gdpr_breach_incidents_dpo_admin` + `gdpr_breach_incidents_company_only`

**Recomendaci√≥n**: Mantener `gdpr_breach_incidents_dpo_admin`, eliminar `gdpr_breach_incidents_company_only`.

---

### 8. **gdpr_consent_records** (16 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT, INSERT, UPDATE, DELETE

**Pol√≠ticas duplicadas**:
- `gdpr_consent_records_company` + `gdpr_consent_records_company_only`

**Recomendaci√≥n**: Mantener `gdpr_consent_records_company_only`, eliminar `gdpr_consent_records_company`.

---

### 9. **gdpr_consent_requests** (4 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT

**Pol√≠ticas duplicadas**:
- `gcr_company_policy` + `gdpr_consent_requests_company_only`

**Recomendaci√≥n**: Mantener `gdpr_consent_requests_company_only`, eliminar `gcr_company_policy`.

---

### 10. **gdpr_processing_activities** (16 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT, INSERT, UPDATE, DELETE

**Pol√≠ticas duplicadas**:
- `gdpr_processing_activities_admin_only` + `gdpr_processing_activities_company_only`

**Recomendaci√≥n**: Mantener `gdpr_processing_activities_admin_only`, eliminar `gdpr_processing_activities_company_only`.

---

### 11. **localities** (4 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT

**Pol√≠ticas duplicadas**:
- `Anyone can view localities` + `localities_read_all`

**Recomendaci√≥n**: Mantener `localities_read_all`, eliminar `Anyone can view localities`.

---

### 12. **pending_users** (12 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT, INSERT, UPDATE

**Pol√≠ticas duplicadas**:
- `Users can view own pending registrations` + `pending_users_company_or_service`
- `System can insert pending users` + `pending_users_company_or_service`
- `System can update pending users` + `pending_users_company_or_service`

**Recomendaci√≥n**: Mantener `pending_users_company_or_service`, eliminar las 3 legacy.

---

### 13. **ticket_comments** (16 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT, INSERT, UPDATE, DELETE

**Pol√≠ticas duplicadas**:
- `Comments selectable by company members` + `ticket_comments_company_only`
- `Comments insert by company members` + `ticket_comments_company_only`
- `Comments update by author` + `ticket_comments_company_only`
- `Comments delete by author` + `ticket_comments_company_only`

**Recomendaci√≥n**: Mantener `ticket_comments_company_only`, eliminar las 4 legacy.

---

### 14. **ticket_devices** (8 warnings)
**Roles afectados**: anon, authenticated, authenticator, dashboard_user  
**Acciones duplicadas**: SELECT, INSERT

**Pol√≠ticas duplicadas**:
- `Users can manage ticket devices from their company` + `ticket_devices_via_ticket`
- `Users can insert ticket devices from their company` + `ticket_devices_via_ticket`

**Recomendaci√≥n**: Mantener `ticket_devices_via_ticket`, eliminar las 2 legacy.

---

### 15. **users** (2 warnings)
**Roles afectados**: authenticated  
**Acciones duplicadas**: SELECT, UPDATE

**Pol√≠ticas duplicadas**:
- `users_own_profile` + `allow_all_for_users` (SELECT)
- `users_own_update` + `allow_all_for_users` (UPDATE)

**Recomendaci√≥n**: **CUIDADO** - `allow_all_for_users` es muy permisiva (permite TODO a authenticated).
- Mantener `users_own_profile` y `users_own_update` (m√°s restrictivas)
- Eliminar `allow_all_for_users` (demasiado permisiva, riesgo de seguridad)

---

## ‚úÖ Script de Limpieza (EJECUTAR CON PRECAUCI√ìN)

```sql
-- ============================================================================
-- LIMPIEZA DE POL√çTICAS RLS DUPLICADAS
-- ============================================================================
-- ‚ö†Ô∏è IMPORTANTE: Ejecutar EN ORDEN y VERIFICAR despu√©s de cada bloque
-- ============================================================================

-- PASO 1: Eliminar pol√≠ticas legacy de addresses
DROP POLICY IF EXISTS "Users can view own addresses" ON public.addresses;
DROP POLICY IF EXISTS "Users can insert own addresses" ON public.addresses;
DROP POLICY IF EXISTS "Users can update own addresses" ON public.addresses;
DROP POLICY IF EXISTS "Users can delete own addresses" ON public.addresses;

-- PASO 2: Eliminar pol√≠ticas redundantes de companies
DROP POLICY IF EXISTS "companies_own_view" ON public.companies;
DROP POLICY IF EXISTS "companies_owner_edit" ON public.companies;
DROP POLICY IF EXISTS "allow_all_for_companies" ON public.companies;

-- PASO 3: Eliminar pol√≠ticas legacy de company_invitations
DROP POLICY IF EXISTS "Company members can view invitations" ON public.company_invitations;
DROP POLICY IF EXISTS "Owners and admins can create invitations" ON public.company_invitations;
DROP POLICY IF EXISTS "Inviter can update invitations" ON public.company_invitations;

-- PASO 4: Eliminar pol√≠ticas redundantes de GDPR
DROP POLICY IF EXISTS "gdpr_access_requests_company" ON public.gdpr_access_requests;
DROP POLICY IF EXISTS "gdpr_audit_log_company_only" ON public.gdpr_audit_log;
DROP POLICY IF EXISTS "gdpr_breach_incidents_company_only" ON public.gdpr_breach_incidents;
DROP POLICY IF EXISTS "gdpr_consent_records_company" ON public.gdpr_consent_records;
DROP POLICY IF EXISTS "gcr_company_policy" ON public.gdpr_consent_requests;
DROP POLICY IF EXISTS "gdpr_processing_activities_company_only" ON public.gdpr_processing_activities;

-- PASO 5: Eliminar pol√≠ticas legacy de localities
DROP POLICY IF EXISTS "Anyone can view localities" ON public.localities;

-- PASO 6: Eliminar pol√≠ticas legacy de pending_users
DROP POLICY IF EXISTS "Users can view own pending registrations" ON public.pending_users;
DROP POLICY IF EXISTS "System can insert pending users" ON public.pending_users;
DROP POLICY IF EXISTS "System can update pending users" ON public.pending_users;

-- PASO 7: Eliminar pol√≠ticas legacy de ticket_comments
DROP POLICY IF EXISTS "Comments selectable by company members" ON public.ticket_comments;
DROP POLICY IF EXISTS "Comments insert by company members" ON public.ticket_comments;
DROP POLICY IF EXISTS "Comments update by author" ON public.ticket_comments;
DROP POLICY IF EXISTS "Comments delete by author" ON public.ticket_comments;

-- PASO 8: Eliminar pol√≠ticas legacy de ticket_devices
DROP POLICY IF EXISTS "Users can manage ticket devices from their company" ON public.ticket_devices;
DROP POLICY IF EXISTS "Users can insert ticket devices from their company" ON public.ticket_devices;

-- PASO 9: CR√çTICO - Eliminar pol√≠tica permisiva de users
-- ‚ö†Ô∏è VERIFICAR QUE users_own_profile y users_own_update funcionen antes de ejecutar
DROP POLICY IF EXISTS "allow_all_for_users" ON public.users;
```

---

## üß™ Verificaci√≥n Post-Limpieza

```sql
-- Verificar que no quedan pol√≠ticas duplicadas
SELECT 
    tablename,
    COUNT(*) as policy_count,
    string_agg(policyname, ', ') as policies
FROM pg_policies
WHERE schemaname = 'public'
GROUP BY tablename, cmd
HAVING COUNT(*) > 1
ORDER BY tablename;

-- Resultado esperado: 0 filas (sin duplicados)
```

---

## üìÖ Calendario de Limpieza Recomendado

### **AHORA (Octubre 2025)**
‚úÖ Fix #1: √çndices duplicados (EJECUTADO)  
‚úÖ Fix #2: Auth RLS InitPlan (EJECUTADO)  

### **Pr√≥xima Semana**
- Pruebas exhaustivas de las pol√≠ticas modernas
- Monitoreo de logs de errores
- Confirmaci√≥n de que todo funciona correctamente

### **En 2-3 Semanas (si todo va bien)**
- Ejecutar script de limpieza de pol√≠ticas duplicadas
- Verificar que warnings de Supabase bajan de 192 a ~3

---

## üéØ Resultado Final Esperado

**Antes de limpieza**:
- 192 warnings totales
- 33 auth_rls_initplan ‚úÖ CORREGIDOS
- 156 multiple_permissive_policies ‚è≥ PENDIENTE
- 3 duplicate_index ‚úÖ CORREGIDOS

**Despu√©s de limpieza completa**:
- 0 warnings totales üéâ
- Sistema m√°s eficiente y mantenible
- Sin impacto en seguridad o funcionalidad

---

## ‚ö†Ô∏è PRECAUCIONES

1. **NO ejecutar script de limpieza en producci√≥n sin pruebas previas**
2. **Hacer backup de base de datos antes de eliminar pol√≠ticas**
3. **Probar en ambiente de desarrollo primero**
4. **Monitorear logs de errores despu√©s de cada cambio**
5. **Tener plan de rollback preparado**

---

## üìö Referencias

- [Supabase RLS Performance](https://supabase.com/docs/guides/database/postgres/row-level-security#call-functions-with-select)
- [PostgreSQL Policy Documentation](https://www.postgresql.org/docs/current/sql-createpolicy.html)
- [Linter Documentation](https://supabase.com/docs/guides/database/database-linter?lint=0006_multiple_permissive_policies)

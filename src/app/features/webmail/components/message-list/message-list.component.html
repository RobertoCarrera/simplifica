<div class="message-list-container">
    <div class="toolbar">
        <div class="bulk-actions" *ngIf="selectionCount > 0; else searchMode">
            <div class="selection-info">
                <input type="checkbox" [checked]="allSelected()" (change)="toggleSelectAll($event)">
                <span>{{ selectionCount }} seleccionados</span>
            </div>
            <div class="actions">
                <button class="btn-icon" title="Marcar como leídos" (click)="markSelectedRead(true)"><i
                        class="fas fa-envelope-open"></i></button>
                <button class="btn-icon" title="Marcar como no leídos" (click)="markSelectedRead(false)"><i
                        class="fas fa-envelope"></i></button>
                <div class="separator"></div>
                <!-- Future: Move to folder -->
                <button class="btn-icon" title="Mover a Papelera" (click)="deleteSelected()"><i
                        class="fas fa-trash"></i></button>
            </div>
        </div>

        <ng-template #searchMode>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Buscar correos...">
            </div>

            <!-- Standard toolbar actions if needed, or Select All trigger -->
            <div class="actions">
                <div class="checkbox-wrapper">
                    <input type="checkbox" [checked]="allSelected()" (change)="toggleSelectAll($event)"
                        title="Seleccionar todo">
                </div>
                <!-- Refresh etc -->
            </div>
        </ng-template>
    </div>

    <div class="list-content">
        <div class="messages">
            <!-- Loading -->
            <div class="loading-state" *ngIf="loading()">
                <i class="fas fa-circle-notch fa-spin"></i>
                <p>Cargando mensajes...</p>
            </div>

            <!-- Empty -->
            <div class="empty-state" *ngIf="!loading() && store.threads().length === 0">
                <i class="fas fa-inbox"></i>
                <p>No hay correos en esta carpeta</p>
            </div>

            <!-- List -->
            <div class="message-item" *ngFor="let thread of store.threads()" [class.unread]="!thread.is_read"
                [class.selected]="isSelected(thread.thread_id)" (click)="onMessageClick(thread)">

                <div class="checkbox" (click)="$event.stopPropagation()">
                    <input type="checkbox" [checked]="isSelected(thread.thread_id)"
                        (click)="toggleSelection($event, thread.thread_id)">
                </div>

                <div class="avatar">
                    <!-- Show initial of first participant or '?' -->
                    {{ (thread.participants && thread.participants[0] ? thread.participants[0] :
                    '?').charAt(0).toUpperCase() }}
                </div>

                <div class="content">
                    <div class="header">
                        <span class="sender">{{ thread.participants?.join(', ') || 'Desconocido' }}</span>
                        <span class="date">{{ thread.last_message_at | date:'M/d/yy' }}</span>
                    </div>
                    <div class="subject-row">
                        <span class="subject">{{ thread.subject || '(Sin asunto)' }}</span>
                        <span class="count-badge" *ngIf="thread.message_count > 1">{{ thread.message_count }}</span>
                    </div>
                    <div class="snippet">{{ thread.snippet }}</div>
                </div>
            </div>
        </div>
    </div>
</div>
<div *ngIf="showForm" class="modal-overlay">
    <div class="modal-content" [class.modal-medium]="false">
        <div class="modal-header">
            <div class="modal-header-text">
                <h2 class="modal-title">
                    <i class="fas" [class.fa-plus-circle]="!editingTicket" [class.fa-edit]="editingTicket"></i>
                    {{ editingTicket ? ('Editando Ticket #' + editingTicket.ticket_number) : 'Nuevo Ticket' }}
                </h2>
                <p class="modal-subtitle">
                    {{ editingTicket ? 'Actualice la información del ticket' : 'Complete los detalles para crear un
                    nuevo ticket'
                    }}
                </p>
            </div>
            <button class="modal-close" (click)="closeForm()" aria-label="Cerrar">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <form class="ticket-form">
                <!-- Título y Descripción -->
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="title">Título del Problema *</label>
                        <input type="text" id="title" [(ngModel)]="formData.title" name="title" class="form-control"
                            [class.error]="formErrors['title']" placeholder="Ej: Pantalla rota iPhone 13" required>
                        <span class="error-message" *ngIf="formErrors['title']">{{ formErrors['title'] }}</span>
                    </div>
                    <div class="form-group relative customer-search-container">
                        <label for="client">Cliente *</label>
                        <div class="customer-input-wrapper">
                            <input type="text" id="client" class="form-control customer-search-input"
                                [(ngModel)]="customerSearchText" (input)="filterCustomers()"
                                (focus)="onCustomerSearchFocus()" (blur)="onCustomerSearchBlur()" name="client_search"
                                [class.error]="formErrors['client_id']" placeholder="Buscar cliente..."
                                autocomplete="off">

                            <button type="button" *ngIf="selectedCustomer" class="btn-clear-customer"
                                (click)="clearCustomerSelection()">
                                <i class="fas fa-times"></i>
                            </button>

                            <button type="button" class="btn-add-customer" (click)="openCustomerForm()"
                                title="Nuevo Cliente">
                                <i class="fas fa-user-plus"></i>
                            </button>
                        </div>

                        <span class="error-message" *ngIf="formErrors['client_id']">{{ formErrors['client_id'] }}</span>

                        <!-- Dropdown de resultados -->
                        <div class="customer-dropdown" *ngIf="showCustomerDropdown">
                            <div class="customer-option" *ngFor="let customer of filteredCustomers"
                                (click)="selectCustomer(customer)">
                                <div class="customer-name">{{ customer.name }}</div>
                                <div class="customer-details">
                                    <span *ngIf="customer.email">{{ customer.email }}</span>
                                    <span *ngIf="customer.phone"> • {{ customer.phone }}</span>
                                </div>
                            </div>

                            <div class="customer-option create-new-customer" *ngIf="filteredCustomers.length === 0"
                                (click)="createNewCustomer()">
                                <div class="customer-name">
                                    <i class="fas fa-plus-circle"></i>
                                    Crear "{{ customerSearchText }}"
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="assigned_to">Asignar a</label>
                        <select id="assigned_to" [(ngModel)]="formData.assigned_to" name="assigned_to"
                            class="form-select">
                            <option [ngValue]="undefined">Sin asignar</option>
                            <!-- Use ngValue undefined for unassigned -->
                            <option *ngFor="let staff of staffUsers" [value]="staff.id">
                                {{ staff.full_name || staff.email }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Descripción Detallada *</label>
                    <textarea id="description" [(ngModel)]="formData.description" name="description"
                        class="form-textarea" [class.error]="formErrors['description']" rows="4"
                        placeholder="Describa el problema detalladamente..." required></textarea>
                    <span class="error-message" *ngIf="formErrors['description']">{{ formErrors['description'] }}</span>
                </div>

                <!-- Cliente y Estado -->
                <div class="form-row">
                    <!-- Buscador de Clientes -->
                    <div class="form-group">
                        <label for="priority">Prioridad</label>
                        <select id="priority" [(ngModel)]="formData.priority" name="priority" class="form-select">
                            <option value="low">Baja</option>
                            <option value="normal">Normal</option>
                            <option value="high">Alta</option>
                            <option value="critical">Crítica</option>
                            <option value="urgent">Urgente</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="stage">Estado *</label>
                        <select id="stage" [(ngModel)]="formData.stage_id" name="stage_id" class="form-select"
                            [class.error]="formErrors['stage_id']" required>
                            <option value="" disabled>Seleccione un estado</option>
                            <option *ngFor="let stage of stages" [value]="stage.id">
                                {{ stage.name }}
                            </option>
                        </select>
                        <span class="error-message" *ngIf="formErrors['stage_id']">{{ formErrors['stage_id'] }}</span>
                    </div>
                    <div class="form-group">
                        <label for="estimated_hours">Horas Estimadas</label>
                        <input type="number" id="estimated_hours" [(ngModel)]="formData.estimated_hours"
                            name="estimated_hours" class="form-control" min="0" step="0.5">
                    </div>
                </div>

                <!-- Tags Selection -->
                <div class="form-group">
                    <label>Etiquetas</label>
                    <div
                        class="flex flex-wrap gap-2 mb-2 p-2 border border-gray-200 dark:border-gray-700 rounded-lg min-h-[42px]">
                        <div *ngFor="let tag of selectedTags"
                            class="inline-flex items-center px-2 py-1 rounded-md text-sm font-medium"
                            [style.background-color]="getTagColor(tag)"
                            [style.color]="getContrastColor(getTagColor(tag))">
                            {{ tag }}
                            <button type="button" class="ml-2 opacity-70 hover:opacity-100"
                                (click)="removeTagFromTicket(tag)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <input type="text"
                            class="flex-1 min-w-[120px] bg-transparent border-none focus:ring-0 text-sm p-0"
                            placeholder="Añadir etiqueta..." [(ngModel)]="tagSearchText" name="tag_input"
                            (keydown.enter)="$event.preventDefault(); addTagToTicket(tagSearchText); tagSearchText = ''">
                    </div>

                    <!-- Quick select common tags -->
                    <div class="flex flex-wrap gap-2 mt-1">
                        <button *ngFor="let tag of availableTags" type="button"
                            class="px-2 py-1 text-xs rounded-full transition-colors font-medium border-none shadow-sm"
                            [style.background-color]="tag.color" [style.color]="getContrastColor(tag.color)"
                            [class.opacity-50]="selectedTags.includes(tag.name)"
                            [disabled]="selectedTags.includes(tag.name)" (click)="addTagToTicket(tag.name)">
                            {{ tag.name }}
                        </button>
                    </div>
                </div>

                <!-- Servicios Section -->
                <div class="services-section">
                    <div class="services-header">
                        <h3>
                            <i class="fas fa-tools"></i>
                            Servicios y Mano de Obra
                        </h3>
                        <button type="button" class="btn btn-primary btn-sm" (click)="openServiceForm()">
                            <i class="fas fa-plus"></i>
                            Nuevo
                        </button>
                    </div>

                    <!-- Error de servicios -->
                    <div *ngIf="formErrors['services']" class="error-message">
                        {{ formErrors['services'] }}
                    </div>

                    <div class="available-services">
                        <!-- Search Input -->
                        <div class="search-container">
                            <input type="text" class="search-input" [(ngModel)]="serviceSearchText"
                                (input)="filterServices()" name="service_search" placeholder="Buscar servicios...">
                            <i class="fas fa-search search-icon"></i>
                        </div>

                        <!-- Services Grid -->
                        <div class="services-grid" *ngIf="filteredServices.length > 0">
                            <div *ngFor="let service of filteredServices" class="service-item"
                                [class.selected]="isServiceSelected(service.id)"
                                [class.has-variants]="service.variants && service.variants.length > 0"
                                (click)="(!service.variants || service.variants.length === 0) && addServiceToTicket(service)">
                                <div class="service-info">
                                    <div class="service-name">
                                        {{ service.name }}
                                        <span class="price-label-badge" *ngIf="service.base_price > 0">{{
                                            service.base_price }}€</span>
                                    </div>
                                    <div class="service-tags" *ngIf="service.tags && service.tags.length > 0">
                                        <span *ngFor="let t of service.tags" class="service-tag">{{ t }}</span>
                                    </div>
                                    <!-- If service has variants, show chips -->
                                    <div *ngIf="service.variants && service.variants.length > 0"
                                        class="service-variants-list">
                                        <div class="variant-label">Variantes disponibles:</div>
                                        <div class="variants-chips">
                                            <div *ngFor="let v of service.variants" class="variant-chip"
                                                (click)="$event.stopPropagation(); addServiceToTicket(service, v)">
                                                <span class="v-name">{{ v.variant_name }}</span>
                                                <span class="v-price">{{ getVariantPrice(v) }}€</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="service-description"
                                        *ngIf="!service.variants || service.variants.length === 0">{{
                                        service.description }}</div>
                                </div>
                                <div class="service-actions" *ngIf="!service.variants || service.variants.length === 0">
                                    <button type="button" class="btn-add">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="filteredServices.length === 0" class="no-results">
                            <i class="fas fa-search"></i>
                            <p>No se encontraron servicios</p>
                        </div>
                    </div>

                    <!-- Servicios Seleccionados -->
                    <div *ngIf="selectedServices.length > 0" class="selected-services">
                        <h4>Servicios Seleccionados</h4>
                        <div class="selected-services-list">
                            <div *ngFor="let item of selectedServices" class="selected-service-item">
                                <div class="service-info">
                                    <div class="service-name">
                                        {{ item.service.name }}
                                        <span *ngIf="item.variant" class="selected-variant-badge">{{
                                            item.variant.variant_name
                                            }}</span>
                                    </div>
                                    <div class="service-price">{{ item.unit_price }}€ × {{ item.quantity }}</div>
                                </div>
                                <div class="service-controls">
                                    <input type="number" [value]="item.quantity"
                                        (input)="updateServiceQuantity(item.service.id, +$any($event.target).value, item.variant?.id)"
                                        min="1" class="quantity-input">
                                    <button type="button" class="btn-remove"
                                        (click)="removeServiceFromTicket(item.service.id, item.variant?.id)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Productos Section -->
                <div class="products-section">
                    <div class="services-header">
                        <h3>
                            <i class="fas fa-box"></i>
                            Productos y Repuestos
                        </h3>
                        <button type="button" class="btn btn-primary btn-sm" (click)="openProductForm()">
                            <i class="fas fa-plus"></i>
                            Nuevo
                        </button>
                    </div>

                    <!-- Error de productos -->
                    <div *ngIf="formErrors['items']" class="error-message">
                        {{ formErrors['items'] }}
                    </div>

                    <div class="available-services">
                        <!-- Search Input -->
                        <div class="search-container">
                            <input type="text" class="search-input" [(ngModel)]="productSearchText"
                                (input)="filterProducts()" name="product_search" placeholder="Buscar productos...">
                            <i class="fas fa-search search-icon"></i>
                        </div>

                        <!-- Products Grid -->
                        <div class="services-grid" *ngIf="filteredProducts.length > 0">
                            <div *ngFor="let product of filteredProducts" class="service-item"
                                [class.selected]="isProductSelected(product.id)" (click)="addProductToTicket(product)">
                                <div class="service-info">
                                    <div class="service-name">
                                        {{ product.name }}
                                        <span class="price-label-badge" *ngIf="product.price > 0">{{ product.price
                                            }}€</span>
                                    </div>
                                    <div class="service-details" *ngIf="product.brand || product.model">
                                        {{ product.brand }} {{ product.model }}
                                    </div>
                                    <div class="service-description">{{ product.description }}</div>
                                    <div class="service-details" style="color: #059669;"
                                        *ngIf="product.stock_quantity > 0">
                                        Stock: {{ product.stock_quantity }}
                                    </div>
                                </div>
                                <div class="service-actions">
                                    <button type="button" class="btn-add">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="filteredProducts.length === 0" class="no-results">
                            <i class="fas fa-search"></i>
                            <p>No se encontraron productos</p>
                        </div>
                    </div>

                    <!-- Lista de productos seleccionados -->
                    <div *ngIf="selectedProducts.length > 0" class="selected-services">
                        <h4>Productos Seleccionados</h4>
                        <div class="selected-services-list">
                            <div *ngFor="let item of selectedProducts" class="selected-service-item">
                                <div class="service-info">
                                    <div class="service-name">{{ item.product.name }}</div>
                                    <div class="service-price">{{ item.product.price }}€ × {{ item.quantity }}</div>
                                </div>
                                <div class="service-controls">
                                    <input type="number" [value]="item.quantity"
                                        (input)="updateProductQuantity(item.product.id, +$any($event.target).value)"
                                        min="1" class="quantity-input">
                                    <button type="button" class="btn-remove"
                                        (click)="removeProductFromTicket(item.product.id)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Dispositivos -->
                <div class="devices-section">
                    <div class="section-header">
                        <h3>
                            <i class="fas fa-mobile-alt"></i>
                            Dispositivos
                        </h3>
                        <button type="button" class="btn btn-primary btn-sm" (click)="openCreateDeviceForm()">
                            <i class="fas fa-plus"></i>
                            Nuevo
                        </button>
                    </div>

                    <!-- Error de dispositivos -->
                    <div *ngIf="formErrors['devices']" class="error-message">
                        {{ formErrors['devices'] }}
                    </div>

                    <!-- Selector de dispositivos existentes -->
                    <div class="devices-selector">
                        <h4>
                            <i class="fas fa-search"></i>
                            <span>Dispositivos del Cliente</span>
                        </h4>

                        <div *ngIf="!selectedCustomer" class="info-message">
                            <i class="fas fa-info-circle"></i>
                            <span>Selecciona un cliente para ver sus dispositivos</span>
                        </div>

                        <div *ngIf="selectedCustomer" class="available-devices">
                            <!-- Buscador de dispositivos -->
                            <div class="search-container">
                                <div class="search-input-container">
                                    <input type="text" class="form-control search-input" [(ngModel)]="deviceSearchText"
                                        name="device_search" (input)="filterCustomerDevices()"
                                        placeholder="Buscar dispositivos por marca, modelo, IMEI..." autocomplete="off">
                                    <i class="fas fa-search search-icon"></i>
                                </div>
                            </div>

                            <!-- Lista de dispositivos del cliente -->
                            <div class="devices-list" *ngIf="filteredCustomerDevices.length > 0">
                                <div *ngFor="let device of filteredCustomerDevices" class="device-card"
                                    [class.selected]="isDeviceSelected(device.id)"
                                    (click)="toggleDeviceSelection(device)">
                                    <div class="device-info">
                                        <div class="device-primary">
                                            <span class="device-brand">{{ device.brand }}</span>
                                            <span class="device-model">{{ device.model }}</span>
                                        </div>
                                        <div class="device-details">
                                            <span class="device-imei" *ngIf="device.imei">IMEI: {{ device.imei }}</span>
                                            <span class="device-status" [class]="'status-' + device.status">
                                                {{ getDeviceStatusLabel(device.status) }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="device-actions">
                                        <i class="fas fa-check-circle" *ngIf="isDeviceSelected(device.id)"></i>
                                        <i class="fas fa-plus-circle" *ngIf="!isDeviceSelected(device.id)"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Mensaje cuando no hay dispositivos -->
                            <div *ngIf="selectedCustomer && filteredCustomerDevices.length === 0" class="no-devices">
                                <i class="fas fa-mobile-alt"></i>
                                <p *ngIf="!deviceSearchText.trim()">Este cliente no tiene dispositivos registrados</p>
                                <p *ngIf="deviceSearchText.trim()">No se encontraron dispositivos que coincidan con tu
                                    búsqueda</p>
                            </div>
                        </div>
                    </div>

                    <!-- Dispositivos seleccionados -->
                    <div *ngIf="selectedDevices.length > 0" class="selected-devices">
                        <h4>Dispositivos Seleccionados</h4>
                        <div class="selected-devices-list">
                            <div *ngFor="let device of selectedDevices" class="selected-device-item">
                                <div class="device-info">
                                    <div class="device-name">{{ device.brand }} {{ device.model }}</div>
                                    <div class="device-imei" *ngIf="device.imei">IMEI: {{ device.imei }}</div>
                                    <div class="device-status" [class]="'status-' + device.status">
                                        {{ getDeviceStatusLabel(device.status) }}
                                    </div>
                                </div>
                                <button type="button" class="btn-remove" (click)="removeDeviceFromTicket(device.id)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Inline create-device-form removed; moved to modal for consistency -->
                </div>
            </form>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeForm()">
                <i class="fas fa-times"></i>
                <span>Cancelar</span>
            </button>
            <button class="btn btn-primary" (click)="saveTicket()" [disabled]="loading">
                <i class="fas fa-check"></i>
                <span>{{ editingTicket ? 'Actualizar' : 'Crear' }}</span>
            </button>
        </div>
    </div>
</div>

<!-- Modal para crear dispositivo -->
<div *ngIf="showCreateDeviceForm" class="modal-overlay" (click)="$event.stopPropagation(); cancelCreateDevice()">
    <div class="modal-content modal-medium" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-header-text">
                <h2 class="modal-title">
                    <i class="fas fa-mobile-alt"></i>
                    Nuevo Dispositivo
                </h2>
                <p class="modal-subtitle">Registre el dispositivo del cliente</p>
            </div>
            <button class="modal-close" (click)="cancelCreateDevice()" aria-label="Cerrar">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label for="device_brand">Marca *</label>
                    <input type="text" id="device_brand" [(ngModel)]="deviceFormData.brand" name="device_brand"
                        class="form-control" placeholder="Ej: Apple, Samsung, Xiaomi">
                </div>
                <div class="form-group">
                    <label for="device_model">Modelo *</label>
                    <input type="text" id="device_model" [(ngModel)]="deviceFormData.model" name="device_model"
                        class="form-control" placeholder="Ej: iPhone 14, Galaxy S23">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="device_imei">IMEI</label>
                    <input type="text" id="device_imei" [(ngModel)]="deviceFormData.imei" name="device_imei"
                        class="form-control" placeholder="Número IMEI del dispositivo">
                </div>
                <div class="form-group">
                    <label for="device_color">Color</label>
                    <input type="text" id="device_color" [(ngModel)]="deviceFormData.color" name="device_color"
                        class="form-control" placeholder="Color del dispositivo">
                </div>
                <div class="form-group">
                    <label for="device_type">Tipo *</label>
                    <select id="device_type" [(ngModel)]="deviceFormData.device_type" name="device_type"
                        class="form-control">
                        <option value="">Seleccionar tipo</option>
                        <option value="smartphone">Smartphone</option>
                        <option value="tablet">Tablet</option>
                        <option value="laptop">Portátil</option>
                        <option value="desktop">Ordenador</option>
                        <option value="console">Consola</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="reported_issue">Problema Reportado *</label>
                    <textarea id="reported_issue" [(ngModel)]="deviceFormData.reported_issue" name="reported_issue"
                        class="form-control" rows="2" placeholder="Describe el problema reportado por el cliente">
            </textarea>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="device_notes">Estado al llegar</label>
                    <textarea id="device_notes" [(ngModel)]="deviceFormData.condition_on_arrival" name="device_notes"
                        class="form-control" rows="3" placeholder="Estado inicial, accesorios incluidos, etc.">
            </textarea>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="device_images">Imágenes del dispositivo</label>
                    <div class="image-upload-container">
                        <input type="file" id="device_images" (change)="onDeviceImagesSelected($event)"
                            name="device_images" accept="image/*" multiple class="file-input">

                        <label for="device_images" class="file-upload-label">
                            <i class="fas fa-camera"></i>
                            <span>Agregar imágenes</span>
                            <small>Arrastra archivos aquí o haz click para seleccionar</small>
                        </label>
                    </div>

                    <div *ngIf="selectedDeviceImages.length > 0" class="image-preview-container">
                        <div class="image-preview-grid">
                            <div *ngFor="let image of selectedDeviceImages; let i = index" class="image-preview-item">
                                <img [src]="image.preview" [alt]="image.file.name">
                                <div class="image-overlay">
                                    <button type="button" class="btn-remove-image" (click)="removeDeviceImage(i)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <span class="image-name">{{ image.file.name }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" (click)="cancelCreateDevice()">
                <i class="fas fa-times"></i>
                <span>Cancelar</span>
            </button>
            <button class="btn btn-primary" (click)="createAndSelectDevice()"
                [disabled]="!deviceFormData.brand || !deviceFormData.model || !deviceFormData.device_type || !deviceFormData.reported_issue">
                <i class="fas fa-check"></i>
                <span>Crear Dispositivo</span>
            </button>
        </div>
    </div>
</div>

<!-- Modal para crear servicio rápido -->
<div *ngIf="showServiceForm" class="modal-overlay" (click)="$event.stopPropagation(); closeServiceForm()">
    <div class="modal-content modal-medium" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-header-text">
                <h2 class="modal-title">
                    <i class="fas fa-tools"></i>
                    Nuevo Servicio
                </h2>
                <p class="modal-subtitle">Cree un nuevo servicio rápido</p>
            </div>
            <button class="modal-close" (click)="closeServiceForm()" aria-label="Cerrar">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label for="service_name">Nombre *</label>
                    <input type="text" id="service_name" [(ngModel)]="serviceFormData.name" name="service_name"
                        class="form-control" placeholder="Ej: Reparación de pantalla">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="service_price">Precio Base (€)</label>
                    <input type="number" id="service_price" [(ngModel)]="serviceFormData.base_price"
                        name="service_price" class="form-control" min="0" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="service_hours">Horas Estimadas</label>
                    <input type="number" id="service_hours" [(ngModel)]="serviceFormData.estimated_hours"
                        name="service_hours" class="form-control" min="0" step="0.5" placeholder="1">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="service_description">Descripción</label>
                    <textarea id="service_description" [(ngModel)]="serviceFormData.description"
                        name="service_description" class="form-control" rows="2"
                        placeholder="Descripción del servicio..."></textarea>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeServiceForm()">
                <i class="fas fa-times"></i>
                <span>Cancelar</span>
            </button>
            <button class="btn btn-primary" (click)="createServiceFromTicket()">
                <i class="fas fa-check"></i>
                <span>Crear Servicio</span>
            </button>
        </div>
    </div>
</div>

<!-- Modal para crear cliente completo -->
<div *ngIf="showCustomerForm" class="modal-overlay" (click)="$event.stopPropagation(); closeCustomerForm()">
    <div class="modal-content modal-medium" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-header-text">
                <h2 class="modal-title">
                    <i class="fas fa-user-plus"></i>
                    Nuevo Cliente
                </h2>
                <p class="modal-subtitle">Complete la información del cliente</p>
            </div>
            <button class="modal-close" (click)="closeCustomerForm()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <form>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customer_name">Nombre completo *</label>
                        <input type="text" id="customer_name" [(ngModel)]="customerFormData.name" name="customer_name"
                            class="form-control" placeholder="Nombre y apellidos del cliente" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="customer_email">Email</label>
                        <input type="email" id="customer_email" [(ngModel)]="customerFormData.email"
                            name="customer_email" class="form-control" placeholder="cliente@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label for="customer_phone">Teléfono</label>
                        <input type="tel" id="customer_phone" [(ngModel)]="customerFormData.phone" name="customer_phone"
                            class="form-control" placeholder="+34 600 000 000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="customer_address">Dirección</label>
                        <input type="text" id="customer_address" [(ngModel)]="customerFormData.address"
                            name="customer_address" class="form-control" placeholder="Calle, número, piso">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="customer_city">Ciudad</label>
                        <input type="text" id="customer_city" [(ngModel)]="customerFormData.city" name="customer_city"
                            class="form-control" placeholder="Ciudad">
                    </div>
                    <div class="form-group">
                        <label for="customer_postal">Código Postal</label>
                        <input type="text" id="customer_postal" [(ngModel)]="customerFormData.postal_code"
                            name="customer_postal" class="form-control" placeholder="28000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="customer_notes">Notas adicionales</label>
                        <textarea id="customer_notes" [(ngModel)]="customerFormData.notes" name="customer_notes"
                            class="form-control" rows="3" placeholder="Información adicional sobre el cliente...">
              </textarea>
                    </div>
                </div>
            </form>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeCustomerForm()">
                <i class="fas fa-times"></i>
                <span>Cancelar</span>
            </button>
            <button class="btn btn-primary" (click)="saveCustomer()" [disabled]="!customerFormData.name.trim()">
                <i class="fas fa-check"></i>
                <span>Crear Cliente</span>
            </button>
        </div>
    </div>
</div>

<!-- Modal para crear producto -->
<div *ngIf="showProductForm" class="modal-overlay" (click)="$event.stopPropagation(); closeProductForm()">
    <div class="modal-content modal-medium" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-header-text">
                <h2 class="modal-title">
                    <i class="fas fa-box"></i>
                    Nuevo Producto
                </h2>
                <p class="modal-subtitle">Añada un producto al inventario</p>
            </div>
            <button class="modal-close" (click)="closeProductForm()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label for="product_name">Nombre *</label>
                    <input type="text" id="product_name" [(ngModel)]="productFormData.name" name="product_name"
                        class="form-control" placeholder="Ej: Cable USB-C, Funda protectora">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="product_brand">Marca</label>
                    <div class="category-input-container">
                        <input type="text" id="product_brand" class="form-control" [(ngModel)]="productFormData.brand"
                            name="product_brand" (focus)="showBrandInput = true"
                            placeholder="Ej: Samsung, Apple, Xiaomi">

                        <!-- Brand Dropdown -->
                        <div *ngIf="showBrandInput" class="category-dropdown">
                            <div class="category-search">
                                <input type="text" class="form-control small" [(ngModel)]="brandSearchText"
                                    (ngModelChange)="onBrandSearchChange()" placeholder="Buscar o crear marca..."
                                    name="brandFilter">
                            </div>

                            <div class="category-options">
                                <div *ngFor="let brand of filteredBrands" class="category-option"
                                    (click)="selectBrand(brand)">
                                    <i class="fas fa-tag"></i>
                                    <span>{{ brand.name }}</span>
                                    <small *ngIf="brand.company_id">Privada</small>
                                    <small *ngIf="!brand.company_id" style="color: #10b981;">Global</small>
                                </div>

                                <div *ngIf="brandSearchText && filteredBrands.length === 0 && !hasExactBrandMatch()"
                                    class="category-option create-new" (click)="createNewBrand()">
                                    <i class="fas fa-plus" style="color: #10b981;"></i>
                                    <span>Crear "{{ brandSearchText }}"</span>
                                </div>

                                <div *ngIf="brandSearchText && filteredBrands.length === 0 && hasExactBrandMatch()"
                                    class="category-option existing-match" (click)="selectExistingBrandMatch()">
                                    <i class="fas fa-check" style="color: #3b82f6;"></i>
                                    <span>Usar "{{ getExactBrandMatch()?.name }}" (existe)</span>
                                </div>
                            </div>

                            <div class="category-actions">
                                <button type="button" class="btn btn-sm btn-secondary" (click)="showBrandInput = false">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="product_category">Categoría</label>
                    <div class="category-input-container">
                        <input type="text" id="product_category" class="form-control"
                            [(ngModel)]="productFormData.category" name="product_category"
                            (focus)="showCategoryInput = true" placeholder="Ej: Accesorios, Repuestos, Hardware">

                        <!-- Category Dropdown -->
                        <div *ngIf="showCategoryInput" class="category-dropdown">
                            <div class="category-search">
                                <input type="text" class="form-control small" [(ngModel)]="categorySearchText"
                                    (ngModelChange)="onCategorySearchChange()" placeholder="Buscar o crear categoría..."
                                    name="categoryFilter">
                            </div>

                            <div class="category-options">
                                <div *ngFor="let category of filteredCategories" class="category-option"
                                    (click)="selectCategory(category)">
                                    <i [class]="category.icon || 'fas fa-folder'" [style.color]="category.color"></i>
                                    <span>{{ category.name }}</span>
                                    <small *ngIf="category.company_id">Privada</small>
                                    <small *ngIf="!category.company_id" style="color: #10b981;">Global</small>
                                </div>

                                <div *ngIf="categorySearchText && filteredCategories.length === 0 && !hasExactCategoryMatch()"
                                    class="category-option create-new" (click)="createNewCategory()">
                                    <i class="fas fa-plus" style="color: #10b981;"></i>
                                    <span>Crear "{{ categorySearchText }}"</span>
                                </div>

                                <div *ngIf="categorySearchText && filteredCategories.length === 0 && hasExactCategoryMatch()"
                                    class="category-option existing-match" (click)="selectExistingCategoryMatch()">
                                    <i class="fas fa-check" style="color: #3b82f6;"></i>
                                    <span>Usar "{{ getExactCategoryMatch()?.name }}" (existe)</span>
                                </div>
                            </div>

                            <div class="category-actions">
                                <button type="button" class="btn btn-sm btn-secondary"
                                    (click)="showCategoryInput = false">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="product_model">Modelo</label>
                    <input type="text" id="product_model" [(ngModel)]="productFormData.model" name="product_model"
                        class="form-control" placeholder="Modelo o referencia específica">
                </div>
                <div class="form-group">
                    <label for="product_price">Precio (€)</label>
                    <input type="number" id="product_price" [(ngModel)]="productFormData.price" name="product_price"
                        class="form-control" min="0" step="0.01" placeholder="0.00">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="product_stock">Stock Inicial</label>
                    <input type="number" id="product_stock" [(ngModel)]="productFormData.stock_quantity"
                        name="product_stock" class="form-control" min="0" placeholder="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="product_description">Descripción</label>
                    <textarea id="product_description" [(ngModel)]="productFormData.description"
                        name="product_description" class="form-control" rows="3"
                        placeholder="Descripción detallada del producto..."></textarea>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeProductForm()">
                <i class="fas fa-times"></i>
                <span>Cancelar</span>
            </button>
            <button class="btn btn-primary" (click)="createProductFromTicket()"
                [disabled]="!productFormData.name?.trim()">
                <i class="fas fa-check"></i>
                <span>Crear Producto</span>
            </button>
        </div>
    </div>
</div>
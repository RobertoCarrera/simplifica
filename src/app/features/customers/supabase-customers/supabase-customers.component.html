<div class="flex flex-col h-full bg-gray-50 dark:bg-gray-900 border-x border-gray-200 dark:border-gray-800">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 shadow-sm z-10 sticky top-0">
        <div class="px-4 py-4 sm:px-6 lg:px-8 space-y-4">

            <!-- Filters & Search -->
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="relative flex-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" [ngModel]="searchTerm()" (ngModelChange)="onSearchChange($event)"
                        placeholder="Buscar por nombre, email, teléfono o DNI..."
                        class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow sm:text-sm">
                    @if (searchTerm()) {
                    <button (click)="clearFilters()"
                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                    }
                </div>

                <div class="flex gap-2 w-full sm:w-auto overflow-x-auto pb-1 sm:pb-0">
                    <select [(ngModel)]="sortBy" (change)="onFiltersChange()"
                        class="pl-3 pr-8 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        <option value="created_at">Fecha creación</option>
                        <option value="name">Nombre</option>
                        <option value="apellidos">Apellidos</option>
                    </select>

                    <button (click)="sortOrder.set(sortOrder() === 'asc' ? 'desc' : 'asc'); onFiltersChange()"
                        class="p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors"
                        [title]="sortOrder() === 'asc' ? 'Orden ascendente' : 'Orden descendente'">
                        <i class="fas" [class.fa-sort-amount-down]="sortOrder() === 'desc'"
                            [class.fa-sort-amount-up]="sortOrder() === 'asc'"></i>
                    </button>


                    <!-- Direct Link to GDPR Manager -->
                    <button (click)="goToGdpr()"
                        class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200 text-sm font-medium rounded-lg transition-colors ml-2 shadow-sm"
                        title="Ir al Gestor RGPD">
                        <i class="fas fa-shield-alt mr-2 text-indigo-600 dark:text-indigo-400"></i>
                        <span class="hidden sm:inline">Gestión RGPD</span>
                    </button>


                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="customers-container flex-1 overflow-hidden relative">
        @if (isLoading() && customers().length === 0) {
        <div class="p-6">
            <app-skeleton type="card-grid" [count]="6"></app-skeleton>
        </div>
        } @else if (filteredCustomers().length === 0) {
        <div
            class="h-full flex flex-col items-center justify-center p-8 text-center text-gray-500 dark:text-gray-400 animate-fade-in">
            <div class="w-24 h-24 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-6">
                <i class="fas fa-users text-4xl text-gray-400 dark:text-gray-500"></i>
            </div>
            <h3 class="text-xl font-medium text-gray-900 dark:text-white mb-2">No se encontraron clientes</h3>
            <p class="max-w-md mx-auto mb-8">
                {{ searchTerm() ? 'Intenta ajustar los filtros de búsqueda.' : 'Comienza añadiendo tu primer cliente o
                importando una lista CSV.' }}
            </p>
            @if (!searchTerm()) {
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <button (click)="openForm()"
                    class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors shadow-sm">
                    <i class="fas fa-plus mr-2"></i> Crear Cliente
                </button>
            </div>
            } @else {
            <button (click)="clearFilters()"
                class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium">
                Limpiar Filtros
            </button>
            }
        </div>
        } @else {
        <!-- Main Scrollable Area -->
        <div class="flex-1 flex flex-col px-4 py-6 pb-0 sm:px-6 lg:px-8 overflow-hidden h-full">

            <!-- Scrollable Grid -->
            <div class="customers-grid">
                @for (customer of filteredCustomers(); track customer.id; let i = $index) {
                <div class="customer-card relative bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow h-full flex flex-col"
                    [style.animation-delay]="i * 50 + 'ms'">

                    <!-- Flip Container for GDPR -->
                    <div class="flip-container h-full" [class.flipped]="flippedCardId() === customer.id">

                        <!-- FRONT: Customer Info -->
                        <div class="flip-front h-full flex flex-col p-4 md:p-5">
                            <!-- Actions Menu Top Right -->
                            <div class="absolute top-4 right-4 z-10">
                                <div class="relative gdpr-actions-menu">

                                    <!-- Dropdown Menu -->
                                    <div [id]="'gdpr-menu-' + customer.id"
                                        class="gdpr-dropdown hidden absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-20 overflow-hidden text-sm divide-y divide-gray-100 dark:divide-gray-700">
                                        <div class="py-1">
                                            <button (click)="editCustomer(customer)"
                                                [disabled]="!hasPendingRectification(customer)"
                                                [class.opacity-50]="!hasPendingRectification(customer)"
                                                [class.cursor-not-allowed]="!hasPendingRectification(customer)"
                                                [title]="!hasPendingRectification(customer) ? 'Edición deshabilitada. Solo disponible si hay una solicitud de rectificación pendiente.' : ''"
                                                class="w-full text-left px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center">
                                                <i class="fas fa-edit w-5 text-gray-400"></i> Editar
                                            </button>
                                            <button (click)="duplicateCustomer(customer)"
                                                class="w-full text-left px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center">
                                                <i class="fas fa-copy w-5 text-gray-400"></i> Duplicar
                                            </button>
                                            <button (click)="openInviteModal(customer)"
                                                class="w-full text-left px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center">
                                                <i class="fas fa-envelope-open-text w-5 text-gray-400"></i> Invitar al
                                                Portal
                                            </button>
                                        </div>
                                        <!-- GDPR Section -->
                                        <div class="py-1 bg-gray-50 dark:bg-gray-700/30">
                                            <button (click)="flipCardToGdpr($event, customer.id)"
                                                class="w-full text-left px-4 py-2 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 flex items-center">
                                                <i class="fas fa-shield-alt w-5"></i> Opciones RGPD
                                            </button>
                                        </div>
                                        <div class="py-1">
                                            <button (click)="deleteCustomer(customer)"
                                                class="w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20 flex items-center">
                                                <i class="fas fa-trash-alt w-5"></i> Eliminar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Customer Header -->
                            <div class="flex items-start gap-4 mb-4 pr-8">
                                <div class="relative shrink-0">
                                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-gray-600 font-bold text-lg shadow-sm"
                                        [style.background]="customer.avatarGradient">
                                        {{ customer.initials }}
                                    </div>
                                    <!-- Online/Active Indicator could go here -->
                                </div>

                                <div class="min-w-0 flex-1">
                                    <h3 class="font-semibold text-gray-900 dark:text-white truncate"
                                        [title]="customer.displayName">
                                        {{ customer.displayName }}
                                    </h3>
                                    <!-- Incomplete warning -->
                                    @if (!isCustomerComplete(customer)) {
                                    <div class="inline-flex items-center gap-1 mt-1 px-1.5 py-0.5 rounded text-[10px] font-medium bg-amber-100 text-amber-800 border border-amber-200"
                                        [title]="formatAttentionReasons(customer)">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Faltan datos
                                    </div>
                                    }
                                    <div class="flex flex-col gap-0.5 text-sm text-gray-500 dark:text-gray-400 mt-1">
                                        @if (customer.email) {
                                        <a [href]="'mailto:' + customer.email"
                                            class="hover:text-blue-600 dark:hover:text-blue-400 truncate flex items-center gap-1.5 transition-colors">
                                            <i class="far fa-envelope text-xs opacity-70"></i> {{ customer.email }}
                                        </a>
                                        }
                                        @if (customer.phone) {
                                        <a [href]="'tel:' + customer.phone"
                                            class="hover:text-blue-600 dark:hover:text-blue-400 truncate flex items-center gap-1.5 transition-colors">
                                            <i class="fas fa-phone text-xs opacity-70"></i> {{ customer.phone }}
                                        </a>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Metadata Grid -->
                            <div class="grid grid-cols-2 gap-y-2 gap-x-4 text-xs mb-4">
                                <div class="flex flex-col">
                                    <span class="text-gray-400 dark:text-gray-500 mb-0.5">DNI/CIF</span>
                                    <span class="text-gray-700 dark:text-gray-300 font-medium truncate">{{ customer.dni
                                        || customer.cif_nif || '-' }}</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-gray-400 dark:text-gray-500 mb-0.5">Alta</span>
                                    <span class="text-gray-700 dark:text-gray-300">{{ customer.formattedDate
                                        }}</span>
                                </div>
                            </div>

                            <!-- Footer Actions (Compact) -->
                            <div
                                class="mt-auto pt-3 border-t border-gray-100 dark:border-gray-700 flex items-center justify-between gap-2">
                                <!-- Portal Access Toggle -->
                                <button
                                    (click)="togglePortalAccess(customer, !hasPortalAccess(customer, customer.email), $event)"
                                    class="flex-1 flex items-center justify-center gap-1.5 py-1.5 rounded text-xs font-medium transition-colors"
                                    [class]="hasPortalAccess(customer, customer.email) 
                    ? 'bg-blue-50 text-blue-700 hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-300' 
                    : 'bg-gray-50 text-gray-600 hover:bg-gray-100 dark:bg-gray-700/50 dark:text-gray-400'">
                                    <i class="fas" [class.fa-key]="hasPortalAccess(customer, customer.email)"
                                        [class.fa-lock]="!hasPortalAccess(customer, customer.email)"></i>
                                    {{ hasPortalAccess(customer, customer.email) ? 'Acceso Portal' : 'Sin Acceso' }}
                                </button>

                                <!-- GDPR Status Badge -->
                                @let badge = getGdprBadgeConfig(customer);
                                <div class="flex items-center gap-1.5 ml-2" [title]="badge.label">
                                    <span
                                        [class]="badge.classes + ' flex items-center justify-center w-6 h-6 rounded-full'">
                                        <i [class]="'fas ' + badge.icon"></i>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- BACK: GDPR Actions -->
                        <div
                            class="flip-back h-full absolute inset-0 bg-gray-900 text-white rounded-lg p-5 flex flex-col items-center justify-center text-center space-y-4 shadow-xl z-20">
                            <button (click)="closeGdprCard($event)"
                                class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors">
                                <i class="fas fa-times text-lg"></i>
                            </button>

                            <div
                                class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mb-1 shadow-lg shadow-blue-900/50">
                                <i class="fas fa-shield-alt text-2xl text-white"></i>
                            </div>

                            <h3 class="font-bold text-lg">Gestión RGPD</h3>

                            <div class="w-full space-y-2">
                                <button (click)="requestDataAccess(customer)"
                                    class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded text-sm font-medium transition-colors flex items-center justify-center gap-2 border border-white/10">
                                    <i class="fas fa-database"></i> Acceso Datos
                                </button>
                                <button (click)="sendConsentRequest(customer)"
                                    class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded text-sm font-medium transition-colors flex items-center justify-center gap-2 border border-white/10">
                                    <i class="fas fa-paper-plane"></i> Pedir Consentimiento
                                </button>
                                <button (click)="exportCustomerData(customer)"
                                    class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded text-sm font-medium transition-colors flex items-center justify-center gap-2 border border-white/10">
                                    <i class="fas fa-file-export"></i> Exportar JSON
                                </button>
                                <div class="h-px bg-white/10 my-1"></div>
                                <button (click)="anonymizeCustomer(customer)"
                                    class="w-full py-2 px-3 bg-red-500/20 hover:bg-red-500/40 text-red-200 hover:text-white rounded text-sm font-medium transition-colors flex items-center justify-center gap-2 border border-red-500/30">
                                    <i class="fas fa-user-slash"></i> Olvido / Anonimizar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                }
            </div>

            <!-- Safe area for mobile fab/nav -->
            <div class="h-20 sm:h-0"></div>

            <!-- Floating Action Buttons (FABs) -->
            <div class="fixed bottom-6 right-6 flex flex-col gap-3 z-40 items-end">
                <!-- Audio Client FAB -->
                <button (click)="toggleRecording()" [class.bg-red-500]="isRecording()"
                    [class.animate-pulse]="isRecording()" [class.bg-purple-600]="!isRecording()"
                    class="p-3 text-white rounded-full shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 hover:bg-purple-700 flex items-center justify-center w-12 h-12"
                    [title]="isRecording() ? 'Detener grabación' : 'Crear cliente por voz (IA)'">
                    @if(isProcessingAudio()) {
                    <i class="fas fa-circle-notch fa-spin text-lg"></i>
                    } @else {
                    <i class="fas text-lg" [class.fa-microphone]="!isRecording()" [class.fa-stop]="isRecording()"></i>
                    }
                </button>

                <!-- New Customer FAB -->
                <button (click)="openForm()"
                    class="p-4 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 flex items-center justify-center w-14 h-14">
                    <i class="fas fa-plus text-xl"></i>
                </button>
            </div>
        </div>
        }
    </div>
</div>

<!-- Add/Edit Customer Slide-over Modal -->
<ng-template #modalTemplate>
    <!-- The component handles its own modal overlay and styling. 
         We render it via Portal to ensure it sits on top of everything (z-index). -->
    <app-form-new-customer [customer]="selectedCustomer()" (onSave)="onCustomerSaved()" (onCancel)="closeForm()"
        (close)="closeForm()">
    </app-form-new-customer>
</ng-template>

<!-- CSV Mapper Modal -->


<!-- Invite Modal -->
@if (showInviteModal()) {
<div class="fixed inset-0 z-[60] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" (click)="closeInviteModal()"></div>

        <div
            class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
            <div class="bg-white dark:bg-gray-800 px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-envelope-open-text text-blue-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">
                            Invitar al Portal de Cliente
                        </h3>
                        <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                            <p>Envía una invitación por email a <strong>{{ inviteTarget()?.name }}</strong>. Podrá
                                establecer su contraseña y acceder a facturas y documentos.</p>
                        </div>

                        <div class="mt-4 space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email
                                    destino</label>
                                <input type="email" [(ngModel)]="inviteEmail"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"
                                    placeholder="cliente@email.com">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mensaje
                                    opcional</label>
                                <textarea [(ngModel)]="inviteMessage" rows="3"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"
                                    placeholder="Hola, te invito a acceder..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <button type="button" (click)="sendInvite()" [disabled]="inviting()"
                    class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto disabled:opacity-50 disabled:cursor-wait">
                    @if(inviting()) { <i class="fas fa-circle-notch fa-spin mr-2"></i> }
                    {{ inviting() ? 'Enviando...' : 'Enviar Invitación' }}
                </button>
                <button type="button" (click)="closeInviteModal()"
                    class="mt-3 inline-flex w-full justify-center rounded-md bg-white dark:bg-gray-800 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 sm:mt-0 sm:w-auto">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>
}
<div
  class="customers-container container-fluid h-full flex flex-col overflow-hidden pb-20 md:pb-8 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100"
  [attr.data-sidebar-collapsed]="sidebarService.isCollapsed() ? '1' : '0'">

  <!-- Inner wrapper: contains header and content; keeps scroll confined to content area like Servicios -->
  <div class="flex-1 flex flex-col p-2 overflow-hidden">
    <!-- Header -->
    <div
      class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 md:p-6 mb-4 md:mb-6 border border-gray-200 dark:border-gray-700 flex-shrink-0">
      <!-- Mobile: Compact Header -->
      <div class="md:hidden mb-4">
        <div class="relative w-full">
          <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
          <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange($event)"
            placeholder="Buscar clientes..."
            class="w-full px-3 py-2 pl-9 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-gray-100 text-sm">
        </div>
      </div>

      @if (!isLoading() || customers().length) {
      <!-- Desktop: Full Header (title left, search+actions right on same row) -->
      <div class="hidden md:block">
        <div class="flex items-center justify-between">
          <!-- Title + subtitle (left) -->
          <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2 leading-none mb-1">
              <i class="fas fa-users text-[24px]"></i>
              Gestión de Clientes
            </h1>
            <p class="text-gray-600 dark:text-gray-300 text-sm mt-1 hidden md:block">Administra toda la información de
              tus clientes</p>
          </div>

          <!-- Search + Actions (right) -->
          <div class="flex items-center gap-3 flex-shrink-0">
            <div class="relative">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange($event)"
                placeholder="Buscar clientes por nombre, email o DNI..."
                class="w-80 px-3 md:px-4 py-2 pl-9 md:pl-10 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-gray-100 text-sm" />
            </div>

            <button (click)="exportCustomers()" class="btn btn-secondary btn-header text-sm font-medium"
              [disabled]="isLoading()" title="Exportar clientes">
              <i class="fas fa-download text-sm"></i>
              <span class="ml-1">Exportar</span>
            </button>

            <input #fileInput type="file" accept=".csv" (change)="onCsvFileSelected($event)" class="hidden" />

            <button (click)="fileInput.click()" class="btn btn-secondary btn-header text-sm font-medium"
              [disabled]="isLoading()" title="Importar clientes desde CSV">
              <i class="fas fa-upload text-sm"></i>
              <span class="ml-1">Importar CSV</span>
            </button>
            <button (click)="goToGdpr()" class="btn btn-secondary btn-header text-sm font-medium ml-2"
              title="Panel de cumplimiento RGPD">
              <i class="fas fa-shield-alt text-sm"></i>
              <span class="ml-1">Gestión GDPR</span>
            </button>
          </div>
        </div>
      </div>
      }

      <!-- Mobile: Action Buttons Row -->
      <div class="md:hidden flex gap-2 mt-3">
        @if (devRoleService.canSeeDevTools()) {
        <button (click)="goToGdpr()" class="btn btn-secondary flex-1 text-xs" title="Panel GDPR">
          <i class="fas fa-shield-alt"></i>
          GDPR
        </button>
        }
        <button (click)="exportCustomers()" class="btn btn-secondary flex-1 text-xs" [disabled]="isLoading()">
          <i class="fas fa-download"></i>
          <span class="ml-2">Exportar</span>
        </button>
        <input #fileInputMobile type="file" accept=".csv" (change)="onCsvFileSelected($event)" class="hidden">
        <button (click)="fileInputMobile.click()" class="btn btn-secondary flex-1 text-xs" [disabled]="isLoading()">
          <i class="fas fa-upload"></i>
          <span class="ml-2">Importar</span>
        </button>
      </div>
    </div>

    <div class="flex-1 overflow-auto">

      <!-- GDPR Panel (Collapsible) -->
      @if (devRoleService.canSeeDevTools() && gdprPanelVisible()) {
      <div class="gdpr-panel mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center">
            <i class="fas fa-shield-alt text-blue-600 text-xl mr-2"></i>
            <h3 class="text-lg font-semibold text-blue-900">Panel de Cumplimiento RGPD</h3>
          </div>
          <button (click)="toggleGdprPanel()" class="btn btn-sm btn-outline">
            <i class="fas fa-times"></i>
            Cerrar
          </button>
        </div>

        @if (complianceStats()) {
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <div class="bg-white rounded-lg p-3 border border-blue-200">
            <div class="flex items-center">
              <i class="fas fa-file-alt text-blue-600 text-lg mr-2"></i>
              <div>
                <div class="text-lg font-bold text-blue-900">{{ complianceStats()?.accessRequestsCount || 0 }}</div>
                <div class="text-xs text-blue-600">Solicitudes RGPD</div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg p-3 border border-green-200">
            <div class="flex items-center">
              <i class="fas fa-check-circle text-green-600 text-lg mr-2"></i>
              <div>
                <div class="text-lg font-bold text-green-900">{{ complianceStats()?.activeConsentsCount || 0 }}</div>
                <div class="text-xs text-green-600">Consentimientos Activos</div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg p-3 border border-yellow-200">
            <div class="flex items-center">
              <i class="fas fa-clock text-yellow-600 text-lg mr-2"></i>
              <div>
                <div class="text-lg font-bold text-yellow-900">{{ complianceStats()?.pendingRequestsCount || 0 }}</div>
                <div class="text-xs text-yellow-600">Solicitudes Pendientes</div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg p-3 border border-red-200">
            <div class="flex items-center">
              <i class="fas fa-exclamation-triangle text-red-600 text-lg mr-2"></i>
              <div>
                <div class="text-lg font-bold text-red-900">{{ complianceStats()?.overdueRequestsCount || 0 }}</div>
                <div class="text-xs text-red-600">Solicitudes Vencidas</div>
              </div>
            </div>
          </div>
        </div>

        <!-- GDPR Quick Actions -->
        <div class="flex flex-wrap gap-2">
          <button (click)="exportComplianceReport()" class="btn btn-sm btn-outline">
            <i class="fas fa-file-export mr-1"></i>
            Exportar Informe RGPD
          </button>
        </div>
        }
      </div>
      }
      <!-- Loading State (Skeletons for Grid) -->
      @if (isLoading() && !customers().length) {
      <div class="customers-grid">
        @for (item of [1,2,3,4,5,6]; track $index) {
        <app-skeleton type="card" width="100%"></app-skeleton>
        }
      </div>
      }

      <!-- Customers Grid -->
      @if (!isLoading() || customers().length) {
      <div class="customers-grid">
        @for (customer of filteredCustomers(); track customer.id; let i = $index) {
        <!-- Customer Card - Optimized Density -->
        <div
          class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 md:p-5 hover:shadow-md transition-shadow">

          <!-- Mobile Layout: 2-column (info left, actions right vertical) -->
          <div class="md:hidden flex gap-3 items-center justify-center">
            <!-- Left column: Avatar + Info -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-3 mb-3">
                <!-- Avatar -->
                <div class="relative flex-shrink-0">
                  @if (customer.avatar_url) {
                  <img [src]="customer.avatar_url" [alt]="customer.name + ' ' + customer.apellidos"
                    class="w-10 h-10 rounded-full object-cover">
                  } @else {
                  <div
                    class="w-10 h-10 rounded-full bg-gradient-to-br {{ getAvatarGradient(customer) }} text-white font-bold text-sm flex items-center justify-center">
                    {{ getCustomerInitials(customer) }}
                  </div>
                  }
                  @if (customer.activo) {
                  <div
                    class="w-3 h-3 bg-green-500 border-2 border-white dark:border-gray-800 rounded-full absolute bottom-0 right-0">
                  </div>
                  }
                </div>

                <!-- Name + Badge -->
                <div class="flex-1 min-w-0">
                  <h3 class="font-semibold text-gray-900 dark:text-gray-100 truncate">
                    {{ getDisplayName(customer) }}
                  </h3>
                  <div class="flex flex-wrap gap-1.5 mt-1">
                    @if (getGdprBadgeConfig(customer); as badge) {
                    <span
                      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium {{ badge.classes }} dark:bg-yellow-500 dark:text-black">
                      <i class="fas {{ badge.icon }} text-[10px]"></i>
                      {{ badge.label }}
                    </span>
                    }
                    @if (!isCustomerComplete(customer)) {
                    <span
                      class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 dark:bg-red-900 text-red-800 dark:text-gray-200"
                      [title]="'Faltan: ' + getCustomerMissingFields(customer).join(', ')">Incompleto</span>
                    }
                  </div>
                </div>
              </div>

              <!-- Contact Info (Max 2 fields) -->
              <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300">
                <div class="flex items-center gap-1.5 truncate">
                  <i class="fas fa-envelope text-gray-400 dark:text-gray-500 text-xs flex-shrink-0 w-4 text-center"></i>
                  <span class="truncate">{{ customer.email }}</span>
                </div>
                @if (customer.phone) {
                <div class="flex items-center gap-1.5">
                  <i class="fas fa-phone text-gray-400 dark:text-gray-500 text-xs flex-shrink-0 w-4 text-center"></i>
                  <span>{{ customer.phone }}</span>
                </div>
                }
              </div>
            </div>

            <!-- Right column: Action Buttons Flex (auto-wrap, right-aligned) -->
            <div class="flex flex-col gap-1 flex-shrink-0 ml-auto justify-end">

              <button (click)="editCustomer(customer)"
                class="w-8 h-8 flex items-center justify-center rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
                title="Editar cliente">
                <i class="fas fa-edit text-sm"></i>
              </button>
              @if (customer.email; as cEmail) {
              @if (!hasPortalAccess(customer, cEmail)) {
              <button (click)="openInviteModal(customer)"
                class="w-8 h-8 flex items-center justify-center rounded-lg bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors"
                [class.opacity-0]="customer?.metadata?.inactive_on_import"
                [disabled]="customer?.metadata?.inactive_on_import" title="Invitar al portal">
                <i class="fas fa-user-plus text-sm"></i>
              </button>
              } @else {
              <button (click)="togglePortalAccess(customer, false, $event)"
                class="w-8 h-8 flex items-center justify-center rounded-lg bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/30 transition-colors"
                [class.opacity-0]="customer?.metadata?.inactive_on_import"
                [disabled]="customer?.metadata?.inactive_on_import" title="Quitar acceso al portal">
                <i class="fas fa-user-times text-sm"></i>
              </button>
              }
              }

              <button (click)="openGdprModal(customer)"
                class="w-8 h-8 flex items-center justify-center rounded-lg bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-colors"
                [class.opacity-0]="customer?.metadata?.inactive_on_import"
                [disabled]="customer?.metadata?.inactive_on_import" title="Acciones RGPD">
                <i class="fas fa-shield-alt text-sm"></i>
              </button>
              <button (click)="deleteCustomer(customer)"
                class="w-8 h-8 flex items-center justify-center rounded-lg bg-pink-500 text-white hover:bg-pink-600 transition-colors"
                title="Eliminar cliente">
                <i class="fas fa-trash text-sm"></i>
              </button>
            </div>
          </div>

          <!-- Desktop Layout: 2-column (info left, actions right vertical) -->
          <div class="hidden md:flex gap-3">
            <!-- Left column: Avatar + Info (flex-1 takes most space) -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-3 mb-3">
                <!-- Avatar -->
                <div class="relative flex-shrink-0">
                  @if (customer.avatar_url) {
                  <img [src]="customer.avatar_url" [alt]="customer.name + ' ' + customer.apellidos"
                    class="w-10 h-10 rounded-full object-cover">
                  } @else {
                  <div
                    class="w-10 h-10 rounded-full bg-gradient-to-br {{ getAvatarGradient(customer) }} text-white font-bold text-sm flex items-center justify-center">
                    {{ getCustomerInitials(customer) }}
                  </div>
                  }
                  @if (customer.activo) {
                  <div
                    class="w-3 h-3 bg-green-500 border-2 border-white dark:border-gray-800 rounded-full absolute bottom-0 right-0">
                  </div>
                  }
                </div>

                <!-- Name + Badge -->
                <div class="flex-1 min-w-0">
                  <h3 class="font-semibold text-gray-900 dark:text-gray-100 truncate flex items-center gap-2">
                    <span>
                      {{ getDisplayName(customer) }}
                    </span>
                  </h3>
                  @if (getGdprBadgeConfig(customer); as badge) {
                  <span
                    class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium {{ badge.classes }} dark:bg-yellow-500 light:bg-yellow-200 dark:text-black">
                    <i class="fas {{ badge.icon }} text-[10px]"></i>
                    {{ badge.label }}
                  </span>
                  }
                  @if (!isCustomerComplete(customer)) {
                  <span
                    class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 dark:bg-red-900 text-red-800 dark:text-gray-200"
                    [title]="'Faltan: ' + getCustomerMissingFields(customer).join(', ')">Incompleto</span>
                  }
                </div>
              </div>

              <!-- Contact Info Vertical (Max 3 fields) -->
              <div class="space-y-1.5 text-sm text-gray-600 dark:text-gray-300">
                <div class="flex items-center gap-1.5">
                  <i class="fas fa-envelope text-gray-400 dark:text-gray-500 w-4 flex-shrink-0"></i>
                  <span class="truncate">{{ customer.email }}</span>
                </div>
                @if (customer.phone) {
                <div class="flex items-center gap-1.5">
                  <i class="fas fa-phone text-gray-400 dark:text-gray-500 w-4 flex-shrink-0"></i>
                  <span>{{ customer.phone }}</span>
                </div>
                }
                @if (customer.client_type === 'business' ? customer.cif_nif : customer.dni) { <div
                  class="flex items-center gap-1.5">
                  <!-- Inline SVG icon to avoid missing FontAwesome glyphs -->
                  <span
                    class="text-gray-400 dark:text-gray-500 w-4 flex-shrink-0 inline-flex items-center justify-center">
                    @if (customer.client_type === 'business') {
                    <!-- Building / company icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-4 h-4" fill="currentColor"
                      aria-hidden="true">
                      <path
                        d="M3 22h18v-2H3v2zM7 10h2v2H7v-2zm4 0h2v2h-2v-2zm4 0h2v2h-2v-2zM5 20V6h14v14H5zm2-12h10V8H7v0z" />
                    </svg>
                    } @else {
                    <!-- ID card / personal icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-4 h-4" fill="currentColor"
                      aria-hidden="true">
                      <path
                        d="M21 4H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7 8c1.66 0 3 1.34 3 3s-1.34 3-3 3S4 12.66 4 11s1.34-3 3-3zm10 8H7c0-2.67 5-4 10-4v4z" />
                    </svg>
                    }
                  </span>
                  <span>{{ customer.client_type === 'business' ? customer.cif_nif : customer.dni }}</span>
                </div>
                }
              </div>
            </div>

            <!-- Right column: Action Buttons Vertical (Hierarchy: important top, dangerous bottom) -->
            <div class="flex flex-col gap-1 flex-shrink-0">
              <button (click)="editCustomer(customer)"
                class="w-8 h-8 flex items-center justify-center rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
                title="Editar cliente">
                <i class="fas fa-edit text-sm"></i>
              </button>
              @if (customer.email; as cEmail) {
              @if (!hasPortalAccess(customer, cEmail)) {
              <button (click)="openInviteModal(customer)"
                class="w-8 h-8 flex items-center justify-center rounded-lg bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors"
                [class.opacity-0]="customer?.metadata?.inactive_on_import"
                [disabled]="customer?.metadata?.inactive_on_import" title="Invitar al portal">
                <i class="fas fa-user-plus text-sm"></i>
              </button>
              } @else {
              <button (click)="togglePortalAccess(customer, false, $event)"
                class="w-8 h-8 flex items-center justify-center rounded-lg bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/30 transition-colors"
                [class.opacity-0]="customer?.metadata?.inactive_on_import"
                [disabled]="customer?.metadata?.inactive_on_import" title="Quitar acceso al portal">
              </button>
              }
              }




              <button (click)="deleteCustomer(customer)"
                class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors"
                title="Eliminar cliente">
                <i class="fas fa-trash text-sm"></i>
              </button>
            </div>
          </div>

        </div>
        }
      </div>
      }

      <!-- Empty State -->
      @if (!isLoading() && !customers().length) {
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-users"></i>
        </div>
        <h3 class="empty-title">No hay clientes todavía</h3>
        <p class="empty-message">Comienza creando tu primer cliente</p>
        <button (click)="openForm()" class="btn btn-primary">
          <i class="fas fa-plus"></i>
          Crear Primer Cliente
        </button>
      </div>
      }

      <!-- No Results -->
      @if (!isLoading() && customers().length && !filteredCustomers().length) {
      <div class="no-results">
        <div class="no-results-icon">
          <i class="fas fa-search"></i>
        </div>
        <h3 class="no-results-title">No se encontraron clientes</h3>
        <p class="no-results-message">Intenta con otros términos de búsqueda</p>
        <button (click)="clearFilters()" class="btn btn-secondary">
          <i class="fas fa-times"></i>
          Limpiar Filtros
        </button>
      </div>
      }

      <!-- Loading Overlay Removed per user feedback to improve UX on return navigation -->
    </div>

  </div>
</div>

<!-- Customer Form Modal -->

<!-- Customer Form Encapsulated Component -->
<app-form-new-customer *ngIf="showForm()" [customer]="selectedCustomer()" [companyId]="auth.companyId()"
  (saved)="onCustomerSaved()" (close)="closeForm()">
</app-form-new-customer>


<!-- Invite Modal -->
@if (showInviteModal()) {
<div class="modal-overlay" (click)="closeInviteModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title-group">
        <h2 class="modal-title">
          <i class="fas fa-user-plus"></i>
          Invitar al Portal de Clientes
        </h2>
        <p class="modal-subtitle">Envía una invitación por email al cliente</p>
      </div>
      <button (click)="closeInviteModal()" class="modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form (ngSubmit)="sendInvite()" #inviteForm="ngForm" class="customer-form">
        <div class="form-row">
          <div class="form-group">
            <label for="inviteEmail" class="form-label">
              <i class="fas fa-envelope"></i>
              Email del cliente
            </label>
            <input type="email" id="inviteEmail" name="inviteEmail" [(ngModel)]="inviteEmail" required
              class="form-input" placeholder="cliente@ejemplo.com">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="inviteMessage" class="form-label">
              <i class="fas fa-comment-dots"></i>
              Mensaje (opcional)
            </label>
            <textarea id="inviteMessage" name="inviteMessage" [(ngModel)]="inviteMessage" class="form-textarea" rows="3"
              placeholder="Hola, te invito a acceder a tu portal de cliente."></textarea>
          </div>
        </div>


        <div class="modal-actions">
          <button type="button" (click)="closeInviteModal()" class="btn-cancel">Cancelar</button>
          <button type="submit" [disabled]="inviting() || !inviteEmail" class="btn-save">
            <i class="fas" [class.fa-paper-plane]="!inviting()" [class.fa-spinner]="inviting()"
              [class.fa-pulse]="inviting()"></i>
            <span>{{ inviting() ? 'Enviando...' : 'Enviar Invitación' }}</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
}



<!-- CSV Header Mapper Modal -->
<app-csv-header-mapper [visible]="showCsvMapper()" [csvHeaders]="csvHeaders()" [csvData]="csvData()"
  [fieldOptions]="customerFieldOptions" [requiredFields]="customerRequiredFields" [aliasMap]="customerAliasMap"
  (mappingConfirmed)="onMappingConfirmed($event)"
  (cancelled)="pendingCsvFile = null; showCsvMapper.set(false)"></app-csv-header-mapper>

<!-- GDPR Management Modal -->
@if (gdprModalClient()) {
<app-client-gdpr-modal [isOpen]="showGdprModal()" [clientId]="gdprModalClient()!.id"
  [clientEmail]="gdprModalClient()!.email"
  [clientName]="gdprModalClient()!.name + ' ' + (gdprModalClient()!.apellidos || '')" (dataModified)="loadCustomers()"
  (closeModal)="showGdprModal.set(false); gdprModalClient.set(null)">
</app-client-gdpr-modal>
}

<!-- Floating Action Button (FAB) -->
<button (click)="toggleRecording()" class="fab-button fab-audio" title="Crear por voz" [class.recording]="isRecording()"
  [disabled]="isLoading() || isProcessingAudio()">
  <i class="fas" [class.fa-microphone]="!isRecording() && !isProcessingAudio()" [class.fa-stop]="isRecording()"
    [class.fa-spinner]="isProcessingAudio()" [class.fa-pulse]="isProcessingAudio()"></i>
</button>

<button (click)="openForm()" class="fab-button" title="Nuevo Cliente" [disabled]="isLoading()">
  <i class="fas fa-plus"></i>
</button>
<div class="modal-overlay" (click)="closeForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title-group">
                <h2 class="modal-title">
                    <i class="fas" [class.fa-plus]="!customer" [class.fa-edit]="customer"></i>
                    {{ customer ? 'Editar Cliente' : 'Nuevo Cliente' }}
                </h2>
                <p class="modal-subtitle">{{ customer ? 'Modifica los datos del cliente' : 'Introduce los datos del
                    nuevo cliente' }}</p>
            </div>
            <button (click)="closeForm()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Customer Form -->
        <div class="modal-body">
            <form (ngSubmit)="saveCustomer()" #customerForm="ngForm" class="customer-form">

                <div class="form-row">
                    <div class="form-group client-type-dropdown-container">
                        <label class="form-label">
                            <i class="fas fa-user-tag"></i>
                            Tipo de cliente
                        </label>
                        <button type="button" (click)="toggleClientTypeDropdown()"
                            class="form-input client-type-button">
                            <span class="client-type-selected">
                                <i [class]="getClientTypeIcon()"></i>
                                {{ getClientTypeLabel() }}
                            </span>
                            <i class="fas fa-chevron-down dropdown-arrow"
                                [class.rotated]="clientTypeDropdownOpen()"></i>
                        </button>

                        @if (clientTypeDropdownOpen()) {
                        <div class="client-type-overlay" (click)="clientTypeDropdownOpen.set(false)"></div>
                        <div class="client-type-dropdown">
                            <div class="dropdown-header">
                                <span>Seleccionar tipo de cliente</span>
                                <button type="button" (click)="clientTypeDropdownOpen.set(false)"
                                    class="dropdown-close">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="dropdown-options">
                                @for (option of clientTypeOptions; track option.value) {
                                <button type="button" (click)="selectClientType(option.value)" class="dropdown-option"
                                    [class.selected]="formData.client_type === option.value">
                                    <i [class]="option.icon"></i>
                                    <span>{{ option.label }}</span>
                                    @if (formData.client_type === option.value) {
                                    <i class="fas fa-check check-icon"></i>
                                    }
                                </button>
                                }
                            </div>
                        </div>
                        }
                    </div>
                </div>

                <!-- Campos para EMPRESA -->
                @if (formData.client_type === 'business') {
                <div class="form-row">
                    <div class="form-group">
                        <label for="business_name" class="form-label">
                            <i class="fas fa-building"></i>
                            Razón social *
                        </label>
                        <input type="text" id="business_name" name="business_name" [(ngModel)]="formData.business_name"
                            required class="form-input" placeholder="Mi Empresa S.L.">
                    </div>
                    <div class="form-group">
                        <label for="cif_nif" class="form-label">
                            <i class="fas fa-id-card"></i>
                            CIF/NIF *
                        </label>
                        <input type="text" id="cif_nif" name="cif_nif" [(ngModel)]="formData.cif_nif" required
                            class="form-input" placeholder="B12345678">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="trade_name" class="form-label">
                            <i class="fas fa-store"></i>
                            Nombre comercial
                        </label>
                        <input type="text" id="trade_name" name="trade_name" [(ngModel)]="formData.trade_name"
                            class="form-input" placeholder="Comercial">
                    </div>
                    <div class="form-group">
                        <label for="legal_representative_name" class="form-label">
                            <i class="fas fa-user-tie"></i>
                            Representante legal
                        </label>
                        <input type="text" id="legal_representative_name" name="legal_representative_name"
                            [(ngModel)]="formData.legal_representative_name" class="form-input"
                            placeholder="Nombre del representante">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="legal_representative_dni" class="form-label">
                            <i class="fas fa-id-badge"></i>
                            DNI representante
                        </label>
                        <input type="text" id="legal_representative_dni" name="legal_representative_dni"
                            [(ngModel)]="formData.legal_representative_dni" class="form-input" placeholder="12345678Z">
                    </div>
                    <div class="form-group">
                        <label for="mercantile_registry_data" class="form-label">
                            <i class="fas fa-file-alt"></i>
                            Registro mercantil (JSON)
                        </label>
                        <textarea id="mercantile_registry_data" name="mercantile_registry_data"
                            [(ngModel)]="formData.mercantile_registry_data" class="form-textarea" rows="3"
                            placeholder='{"tomo": "...", "folio": "..."}'></textarea>
                    </div>
                </div>
                }

                <!-- Campos para PERSONA FÍSICA -->
                @if (formData.client_type === 'individual') {
                <div class="form-row">
                    <div class="form-group">
                        <label for="nombre" class="form-label">
                            <i class="fas fa-user"></i>
                            Nombre *
                        </label>
                        <input type="text" id="nombre" name="nombre" [(ngModel)]="formData.name" required
                            class="form-input" placeholder="Introduce el nombre">
                    </div>

                    <div class="form-group">
                        <label for="apellidos" class="form-label">
                            <i class="fas fa-user"></i>
                            Apellidos *
                        </label>
                        <input type="text" id="apellidos" name="apellidos" [(ngModel)]="formData.apellidos" required
                            class="form-input" placeholder="Introduce los apellidos">
                    </div>
                </div>
                }

                <div class="form-row">
                    <div class="form-group">
                        <label for="email" class="form-label">
                            <i class="fas fa-envelope"></i>
                            Email *
                        </label>
                        <input type="email" id="email" name="email" [(ngModel)]="formData.email" required
                            class="form-input" placeholder="correo@ejemplo.com">
                    </div>

                    <div class="form-group">
                        <label for="telefono" class="form-label">
                            <i class="fas fa-phone"></i>
                            Teléfono
                        </label>
                        <input type="tel" id="telefono" name="telefono" [(ngModel)]="formData.phone" class="form-input"
                            placeholder="666 123 456">
                    </div>
                </div>

                <div class="form-group" *ngIf="formData.client_type === 'individual'">
                    <label for="dni" class="form-label">
                        <i class="fas fa-id-card"></i>
                        DNI/NIF
                    </label>
                    <input type="text" id="dni" name="dni" [(ngModel)]="formData.dni" class="form-input"
                        placeholder="12345678Z">

                    <!-- Honeypot field - hidden from users, detects bots -->
                    <input type="text" [(ngModel)]="formData.honeypot" [name]="honeypotFieldName"
                        style="position:absolute;left:-9999px;width:0;height:0;opacity:0;pointer-events:none;"
                        tabindex="-1" autocomplete="off" aria-hidden="true" [attr.data-honeypot]="true">
                </div>

                <!-- Responsive address row: desktop -> four columns; mobile -> stacked -->
                <div class="form-row grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="form-group relative">
                        <label for="addressTipoVia" class="form-label">Tipo Vía</label>
                        <input id="addressTipoVia" name="addressTipoVia" [(ngModel)]="formData.addressTipoVia"
                            (input)="onAddressViaInput($event)" class="form-input"
                            placeholder="Escribe para buscar tipo vía">
                        <div class="category-input-container">
                            <div *ngIf="viaDropdownOpen" class="category-dropdown">
                                <div class="category-options">
                                    <div *ngFor="let via of filteredVias" class="category-option"
                                        (click)="selectVia(via)">
                                        <span>{{ via }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="addressNombre" class="form-label">Nombre Calle</label>
                        <input type="text" id="addressNombre" name="addressNombre" [(ngModel)]="formData.addressNombre"
                            class="form-input" placeholder="Calle, Avenida...">
                    </div>

                    <div class="form-group">
                        <label for="addressNumero" class="form-label">Número</label>
                        <input type="text" id="addressNumero" name="addressNumero" [(ngModel)]="formData.addressNumero"
                            class="form-input" placeholder="Número">
                    </div>

                    <div class="form-group relative">
                        <label for="addressLocalidadId" class="form-label">Localidad</label>
                        <input id="addressLocalidadId" name="addressLocalidadId" [(ngModel)]="addressLocalityName"
                            (input)="onLocalityInput($event)" class="form-input"
                            placeholder="Buscar por nombre o código postal">
                        <div class="category-input-container">
                            <div *ngIf="localityDropdownOpen" class="category-dropdown">
                                <div class="category-options">
                                    <div *ngFor="let loc of filteredLocalities" class="category-option"
                                        (click)="selectLocality(loc)">
                                        <span>{{ loc.nombre }} - {{ loc.provincia }} (CP: {{ loc.CP }})</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div *ngIf="addressLocalityName" class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline" (click)="openCreateLocality()">
                                <i class="fas fa-plus mr-1"></i> Crear nueva localidad
                            </button>
                        </div>
                    </div>

                    <!-- create-locality modal moved below the form to avoid nested form/ngModel issues -->
                </div>

            </form>

            <!-- create-locality modal (moved out of the parent <form> to avoid ngModel inside a form) -->
            <app-modal [visible]="showCreateLocalityModal" (close)="closeCreateLocality()">
                <h3 class="text-lg font-semibold mb-2">Crear nueva localidad</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Nombre</label>
                        <input #newLocalityNameInput name="newLocalityName" type="text" class="form-input"
                            [(ngModel)]="newLocalityName" (input)="onNewLocalityNameInput($event)"
                            placeholder="Nombre de la localidad">
                        <ul *ngIf="filteredNameSuggestions.length"
                            class="absolute bg-white border rounded mt-1 w-full max-h-40 overflow-auto">
                            <li *ngFor="let s of filteredNameSuggestions" (click)="selectNameSuggestion(s)"
                                class="px-2 py-1 hover:bg-gray-100 cursor-pointer">{{ s }}</li>
                        </ul>
                        <div *ngIf="nameMatchesList.length" class="mt-2 border rounded p-2 bg-gray-50">
                            <div class="text-sm text-gray-600 mb-1">Localidades existentes con ese nombre (elige por CP
                                si
                                corresponde):</div>
                            <ul class="max-h-32 overflow-auto">
                                <li *ngFor="let m of nameMatchesList" (click)="selectExistingFromName(m)"
                                    class="px-2 py-1 hover:bg-gray-100 cursor-pointer">{{ m.nombre }} (CP: {{ m.CP }})
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Provincia</label>
                        <input name="newLocalityProvince" type="text" class="form-input"
                            [(ngModel)]="newLocalityProvince" placeholder="Provincia">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Código Postal</label>
                        <input #newLocalityCPInput name="newLocalityCP" type="text" class="form-input"
                            [(ngModel)]="newLocalityCP" (input)="onNewLocalityCPInput($event)"
                            placeholder="Código Postal">
                    </div>

                    <div class="form-group">
                        <label class="form-label">País</label>
                        <input name="newLocalityCountry" type="text" class="form-input"
                            [value]="newLocalityCountry || 'España'" placeholder="España" readonly tabindex="-1"
                            aria-readonly="true">
                    </div>
                </div>
                <div style="height:12px"></div>
                <div class="modal-actions mt-3 flex justify-end gap-2">
                    <button class="btn btn-secondary" type="button" (click)="closeCreateLocality()">Cancelar</button>
                    <button class="btn btn-primary" type="button" (click)="createLocalityFromInput()"
                        [disabled]="cpExists">Crear
                        localidad</button>
                </div>
                <div *ngIf="cpExists" class="mt-3 p-3 border-l-4 border-yellow-300 bg-yellow-50 rounded">
                    <div class="text-sm">Ya existe una localidad con ese <strong>Código Postal</strong>:</div>
                    <div class="mt-1 font-medium">{{ existingLocalityByCP?.nombre }} (CP: {{ existingLocalityByCP?.CP
                        }})</div>
                    <div class="mt-2">
                        <button class="btn btn-outline btn-sm mr-2"
                            (click)="selectExistingFromName(existingLocalityByCP!)">Seleccionar esta localidad</button>
                        <button class="btn btn-ghost btn-sm" (click)="closeCreateLocality()">Cancelar</button>
                    </div>
                </div>
            </app-modal>
        </div>

        <div class="modal-actions">
            <button type="button" (click)="closeForm()" class="btn-cancel" title="Cancelar">
                <i class="fas fa-times"></i>
                <span>Cancelar</span>
            </button>
            <button type="button" (click)="saveCustomer()" class="btn-save"
                [disabled]="isLoading() || (formData.client_type === 'business' ? !(formData.business_name && formData.cif_nif && formData.email) : !(formData.name && formData.email))"
                [title]="customer ? 'Actualizar' : 'Crear'">
                <i class="fas fa-check"></i>
                <span>{{ customer ? 'Actualizar' : 'Guardar Cliente' }}</span>
            </button>
        </div>
    </div>
</div>
<div class="admin-container">
    <div class="admin-header">
        <h2>Administración de Webmail</h2>
        <p class="subtitle">Gestiona dominios globales y cuentas de usuarios.</p>
    </div>

    <div class="tabs">
        <button class="tab-btn" [class.active]="activeTab === 'domains'" (click)="activeTab = 'domains'">
            <i class="fas fa-globe"></i> Dominios
        </button>
        <button class="tab-btn" [class.active]="activeTab === 'accounts'" (click)="activeTab = 'accounts'">
            <i class="fas fa-users"></i> Cuentas
        </button>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'domains'">
        <div class="toolbar">
            <h3>Dominios Verificados</h3>
            <button class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" (click)="isAddingDomain = !isAddingDomain" *ngIf="!isAddingDomain">
                <i class="fas fa-plus mr-1"></i> Añadir Dominio
            </button>
            <button class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 ml-2" (click)="openAwsModal()">
                <i class="fab fa-aws mr-1"></i> Importar de AWS
            </button>
        </div>

        <div class="add-form" *ngIf="isAddingDomain">
            <div class="search-box">
                <label>Comprobar Disponibilidad</label>
                <div class="input-group flex gap-2">
                    <input type="text" [(ngModel)]="newDomainName" (keyup.enter)="checkAvailability()"
                        class="block w-full max-w-md px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="miempresa.com" [disabled]="isChecking">
                    <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" (click)="checkAvailability()"
                        [disabled]="isChecking || !newDomainName">
                        <i class="fas mr-2" [class.fa-search]="!isChecking" [class.fa-spinner]="isChecking"
                            [class.fa-spin]="isChecking"></i>
                        {{ isChecking ? 'Comprobando...' : 'Buscar' }}
                    </button>
                    <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-gray-600 hover:bg-gray-100 focus:outline-none" (click)="isAddingDomain = false">Cancelar</button>
                </div>
            </div>

            <!-- Search Result -->
            <div class="search-result" *ngIf="checkResult() as res">
                <div class="result-card" [class.available]="res.available" [class.unavailable]="!res.available">
                    <div class="info">
                        <div class="domain-main">
                            <i class="fas" [class.fa-check-circle]="res.available"
                                [class.fa-times-circle]="!res.available"></i>
                            <span class="name">{{ res.domain }}</span>
                        </div>
                        <div class="status-text ml-8 text-sm text-gray-500">
                            {{ res.available ? 'Disponible para registrar' : 'No disponible' }}
                        </div>
                    </div>

                    <div class="action-area flex items-center gap-6">
                        <div class="price-tag text-lg font-bold">{{ res.price }}</div>
                        <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" (click)="registerDomain()">
                            Comprar y Registrar
                        </button>
                    </div>
                </div>

                <p class="hint mt-2 text-xs text-gray-500" *ngIf="res.available">
                    <i class="fas fa-info-circle mr-1"></i> Al comprar, configuraremos automáticamente los DNS y el correo.
                </p>
            </div>
        </div>

        <div class="data-list">
            <div class="data-item header">
                <div>Dominio</div>
                <div>Estado</div>
                <div>Fecha</div>
                <div>Acciones</div>
            </div>
            <div class="data-item" *ngFor="let d of domains()">
                <div class="font-medium">{{ d.domain }}</div>
                <div>
                    <span class="badge" [class.success]="d.is_verified" [class.warning]="!d.is_verified">
                        {{ d.is_verified ? 'Verificado' : 'Pendiente' }}
                    </span>
                </div>
                <div class="text-sm text-muted">{{ d.created_at | date:'shortDate' }}</div>
                <div>
                    <button class="btn-icon danger" (click)="deleteDomain(d.id)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="empty-state" *ngIf="domains().length === 0 && !isAddingDomain">
                No hay dominios configurados.
            </div>
        </div>
    </div>

    <div class="tab-content" *ngIf="activeTab === 'accounts'">
        <div class="toolbar">
            <h3>Todas las Cuentas</h3>
        </div>
        <div class="data-list">
            <div class="data-item header">
                <div>Email</div>
                <div>Usuario (Owner)</div>
                <div>Proveedor</div>
                <div>Activo</div>
            </div>
            <div class="data-item" *ngFor="let a of allAccounts()">
                <div class="font-medium">{{ a.email }}</div>
                <div class="text-secondary text-sm">{{ a.users?.email || 'N/A' }}</div>
                <div><span class="badge gray">{{ a.provider }}</span></div>
                <div>
                    <span class="status-dot" [class.active]="a.is_active"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AWS MODAL OVERLAY -->
<div class="modal-overlay" *ngIf="showAwsModal">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h4>Dominios en AWS Route53</h4>
            <button class="btn-icon" (click)="closeAwsModal()"><i class="fas fa-times"></i></button>
        </div>

        <div class="modal-body">
            <div *ngIf="isLoadingAws" class="loading-state">
                <i class="fas fa-circle-notch fa-spin"></i>
                <p>Cargando dominios desde AWS...</p>
            </div>

            <div class="user-selector-container" *ngIf="!isLoadingAws && users().length > 0">
                <label class="block text-sm font-medium text-gray-700 mb-1">Asignar dominios importados a:</label>
                <div class="selector-wrapper">
                    <select [ngModel]="selectedUserId()" (ngModelChange)="selectedUserId.set($event)"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm user-select">
                        <option [ngValue]="null" disabled>Seleccionar Usuario</option>
                        <option *ngFor="let u of users()" [value]="u.id">
                            {{ u.email }} ({{ u.name || 'Sin nombre' }})
                        </option>
                    </select>
                </div>
            </div>

            <div *ngIf="!isLoadingAws && awsDomains().length === 0" class="empty-state">
                <i class="fas fa-search"></i>
                <p>No se encontraron dominios en Route53 (us-east-1).</p>
            </div>

            <div class="domain-list" *ngIf="!isLoadingAws && awsDomains().length > 0">
                <div *ngFor="let d of awsDomains()" class="domain-item">
                    <div class="domain-info">
                        <span class="d-name">{{ d.DomainName }}</span>
                        <span class="d-status" *ngIf="isDomainImported(d.DomainName)">
                            <i class="fas fa-check-circle text-success"></i> Ya importado
                        </span>
                        <span class="d-status" *ngIf="!isDomainImported(d.DomainName)">
                            Sin vincular
                        </span>
                    </div>
                    <div class="actions">
                        <button class="btn-import" [class.primary]="!isDomainImported(d.DomainName)"
                            [class.disabled]="isDomainImported(d.DomainName)"
                            [disabled]="isDomainImported(d.DomainName)" (click)="importAwsDomain(d.DomainName)">
                            {{ isDomainImported(d.DomainName) ? 'Vinculado' : 'Importar' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
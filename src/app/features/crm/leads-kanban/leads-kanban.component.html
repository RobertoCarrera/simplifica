<div class="h-full flex flex-col" [class.dark]="themeService.currentTheme() === 'dark'">

    <!-- Header / Actions -->
    <div class="flex justify-between items-center mb-6 px-1">
        <div>
            <h2 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight">Tablero de Leads</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400">Gestiona tus oportunidades de negocio</p>
        </div>
        <button (click)="openNewLeadModal()"
            class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-medium shadow-lg shadow-indigo-200 dark:shadow-none hover:shadow-indigo-300 transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
            <i class="fas fa-plus"></i> Nuevo Lead
        </button>
    </div>

    <!-- Board Container -->
    <div class="flex-1 overflow-x-auto overflow-y-hidden" cdkDropListGroup>
        <div class="flex h-full gap-6 pb-4 min-w-fit px-2 pt-2">

            @for (col of columns; track col.id) {
            <div
                class="flex-shrink-0 w-80 flex flex-col bg-slate-50/50 dark:bg-slate-800/20 rounded-2xl border border-slate-200/50 dark:border-slate-700/30 backdrop-blur-sm transition-all duration-300">

                <!-- Column Header -->
                <div class="p-4 flex justify-between items-center sticky top-0 z-10 rounded-t-2xl">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full shadow-sm ring-2 ring-opacity-50"
                            [ngClass]="getStatusDotColor(col.id)" [class.ring-blue-400]="col.id === 'new'"
                            [class.ring-amber-400]="col.id === 'contacted'"
                            [class.ring-purple-400]="col.id === 'meeting_scheduled'"
                            [class.ring-emerald-400]="col.id === 'won'" [class.ring-red-400]="col.id === 'lost'"></div>
                        <h3
                            class="font-bold text-sm uppercase text-slate-700 dark:text-slate-200 tracking-wider text-shadow-sm">
                            {{ col.title }}</h3>
                    </div>
                    <span
                        class="text-xs bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2.5 py-1 rounded-full font-bold shadow-sm border border-slate-100 dark:border-slate-600">
                        {{ col.items.length }}
                    </span>
                </div>

                <!-- Drop List -->
                <div cdkDropList [cdkDropListData]="col.items"
                    class="flex-1 px-3 pb-3 overflow-y-auto space-y-4 scrollbar-hide"
                    (cdkDropListDropped)="drop($event, col.id)">

                    <!-- Lead Card -->
                    @for (lead of col.items; track lead.id) {
                    <div cdkDrag
                        class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] border border-slate-100 dark:border-slate-700 hover:shadow-[0_8px_16px_-4px_rgba(0,0,0,0.1)] hover:border-indigo-200 dark:hover:border-indigo-800 transition-colors cursor-grab active:cursor-grabbing group relative overflow-hidden"
                        (dblclick)="openLead(lead)">

                        <!-- Decorative gradient accent -->
                        <div
                            class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-transparent via-slate-200 dark:via-slate-700 to-transparent opacity-50">
                        </div>

                        <!-- Card Header: Source & Date -->
                        <div class="flex justify-between items-center mb-4">
                            <span
                                class="text-[10px] font-bold uppercase tracking-widest px-2.5 py-1 rounded-lg border shadow-sm backdrop-blur-md"
                                [ngClass]="getSourceBadgeClass(lead.lead_source?.name || lead.source)">
                                <i [class]="getSourceIcon(lead.lead_source?.name || lead.source)"
                                    class="mr-1.5 opacity-80"></i>
                                {{ lead.lead_source?.name || formatSource(lead.source) }}
                            </span>
                            <span class="text-[10px] text-slate-400 font-medium flex items-center gap-1">
                                <i class="far fa-clock text-[9px] opacity-70"></i>
                                {{ lead.created_at | date:'d MMM' }}
                            </span>
                        </div>

                        <!-- Card Title -->
                        <div class="mb-3 pl-2">
                            <h4
                                class="text-base font-bold text-slate-800 dark:text-slate-100 leading-tight flex items-center justify-between gap-2">
                                <span
                                    class="line-clamp-1 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">{{
                                    lead.first_name }} {{ lead.last_name }}</span>
                                @if (isStagnant(lead)) {
                                <div class="relative group/tooltip">
                                    <i class="fas fa-exclamation-circle text-amber-500 animate-pulse text-xs"></i>
                                    <div
                                        class="absolute bottom-full right-0 mb-2 w-max px-2 py-1 bg-slate-800 text-white text-[10px] rounded shadow-lg opacity-0 group-hover/tooltip:opacity-100 transition-opacity pointer-events-none z-50">
                                        Sin actividad > 7 días
                                    </div>
                                </div>
                                }
                            </h4>
                        </div>

                        <!-- Card Details -->
                        @if (lead.interest) {
                        <div class="mb-4 pl-2">
                            <p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-2 leading-relaxed">
                                {{ lead.interest }}
                            </p>
                        </div>
                        }

                        <!-- Card Footer: Actions -->
                        <div
                            class="flex items-center justify-between pt-3 border-t border-slate-50 dark:border-slate-700/30 mt-1 pl-2">
                            <div class="flex gap-3 text-slate-300 dark:text-slate-600">
                                @if (lead.phone) {
                                <span title="Tiene teléfono"
                                    class="hover:text-slate-500 dark:hover:text-slate-400 transition-colors"><i
                                        class="fas fa-phone text-xs"></i></span>
                                }
                                @if (lead.email) {
                                <span title="Tiene email"
                                    class="hover:text-slate-500 dark:hover:text-slate-400 transition-colors"><i
                                        class="fas fa-envelope text-xs"></i></span>
                                }
                            </div>

                            <div class="flex gap-2">
                                @if (authService.userRole() === 'owner') {
                                <button (click)="deleteLead(lead); $event.stopPropagation()"
                                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 text-slate-300 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100 transform translate-x-2 group-hover:translate-x-0"
                                    title="Eliminar">
                                    <i class="fas fa-trash-alt text-xs"></i>
                                </button>
                                }
                                <button (click)="openLead(lead); $event.stopPropagation()"
                                    class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 dark:bg-slate-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all shadow-sm hover:shadow-md"
                                    title="Ver detalle">
                                    <i class="fas fa-chevron-right text-xs"></i>
                                </button>
                            </div>
                        </div>

                    </div>
                    }
                    <!-- End Lead Card -->

                    @if (col.items.length === 0) {
                    <div
                        class="flex flex-col items-center justify-center py-12 text-slate-300 dark:text-slate-600 space-y-2 opacity-50">
                        <i class="far fa-folder-open text-2xl"></i>
                        <span class="text-xs font-medium">Vacío</span>
                    </div>
                    }

                </div>
            </div>
            }

        </div>
    </div>
</div>

<!-- Modals -->
@if (showLeadModal) {
<app-lead-detail-modal [leadId]="selectedLeadId" (closeEvent)="closeLeadModal()" (saveEvent)="onLeadSaved()">
</app-lead-detail-modal>
}
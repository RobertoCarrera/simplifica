<div class="service-variants-container">
  <div class="variants-header">
    <h3>Variantes del Servicio: {{ serviceName }}</h3>
    <button type="button" class="btn btn-primary" (click)="openForm()">
      <i class="fas fa-plus"></i> Nueva Variante
    </button>
  </div>

  <!-- Variants List -->
  <div class="variants-list" *ngIf="variants.length > 0">
    <div class="variant-card" *ngFor="let variant of variants; let i = index"
         [style.border-left-color]="getVariantBadgeColor(variant)">
      <div class="variant-header">
        <div class="variant-title">
          <h4>{{ variant.variant_name }}</h4>
          <span class="variant-period">{{ getPeriodLabel(variant.billing_period) }}</span>
          <span class="variant-badge" *ngIf="variant.display_config?.badge"
                [style.background-color]="getVariantBadgeColor(variant)">
            {{ variant.display_config?.badge }}
          </span>
        </div>
        <div class="variant-actions">
          <button type="button" class="btn-icon" (click)="moveVariantUp(i)" 
                  [disabled]="i === 0" title="Subir">
            <i class="fas fa-arrow-up"></i>
          </button>
          <button type="button" class="btn-icon" (click)="moveVariantDown(i)" 
                  [disabled]="i === variants.length - 1" title="Bajar">
            <i class="fas fa-arrow-down"></i>
          </button>
          <button type="button" class="btn-icon" (click)="openForm(variant)" title="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button type="button" class="btn-icon btn-danger" (click)="deleteVariant(variant.id)" title="Eliminar">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>

      <div class="variant-details">
        <div class="detail-row">
          <span class="detail-label">Precio:</span>
          <span class="detail-value price">{{ variant.base_price | number:'1.2-2' }} €</span>
        </div>
        <div class="detail-row" *ngIf="variant.estimated_hours">
          <span class="detail-label">Horas estimadas:</span>
          <span class="detail-value">{{ variant.estimated_hours }}</span>
        </div>
        <div class="detail-row" *ngIf="variant.discount_percentage && variant.discount_percentage > 0">
          <span class="detail-label">Descuento:</span>
          <span class="detail-value discount">{{ variant.discount_percentage }}%</span>
        </div>
        <div class="detail-row" *ngIf="variant.billing_period === 'monthly'">
          <span class="detail-label">Precio anual (16% desc):</span>
          <span class="detail-value">{{ calculateAnnualPrice(variant.base_price) | number:'1.2-2' }} €</span>
        </div>
      </div>

      <div class="variant-features" *ngIf="variant.features && variant.features.included && variant.features.included.length > 0">
        <h5>Características incluidas:</h5>
        <ul>
          <li *ngFor="let feature of variant.features.included">
            <i class="fas fa-check"></i> {{ feature }}
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="empty-state" *ngIf="variants.length === 0">
    <i class="fas fa-layer-group fa-3x"></i>
    <p>No hay variantes definidas para este servicio</p>
    <button type="button" class="btn btn-primary" (click)="openForm()">
      Crear primera variante
    </button>
  </div>

  <!-- Variant Form Modal -->
  <div class="modal" *ngIf="showForm" (click)="closeForm()" (mousedown)="$event.stopPropagation()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editingVariant ? 'Editar Variante' : 'Nueva Variante' }}</h3>
        <button class="btn-close" type="button" (click)="closeForm()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="saveVariant(); $event.preventDefault()">
          <div class="form-row">
            <div class="form-group">
              <label>Nombre de la Variante *</label>
              <select [(ngModel)]="formData.variant_name" name="variant_name" class="form-control" required>
                <option value="">Selecciona...</option>
                <option *ngFor="let level of variantLevels" [value]="level">{{ level }}</option>
              </select>
            </div>

            <div class="form-group">
              <label>Periodicidad *</label>
              <select [(ngModel)]="formData.billing_period" name="billing_period" class="form-control">
                <option *ngFor="let period of billingPeriods" [value]="period.value">
                  {{ period.label }}
                </option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Precio Base (€) *</label>
              <input type="number" [(ngModel)]="formData.base_price" name="base_price" 
                     class="form-control" step="0.01" min="0">
            </div>

            <div class="form-group">
              <label>Horas Estimadas</label>
              <input type="number" [(ngModel)]="formData.estimated_hours" name="estimated_hours" 
                     class="form-control" step="0.5" min="0">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Precio de Coste (€)</label>
              <input type="number" [(ngModel)]="formData.cost_price" name="cost_price" 
                     class="form-control" step="0.01" min="0">
            </div>

            <div class="form-group">
              <label>Margen de Beneficio (%)</label>
              <input type="number" [(ngModel)]="formData.profit_margin" name="profit_margin" 
                     class="form-control" step="1" min="0" max="100">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Descuento (%)</label>
              <input type="number" [(ngModel)]="formData.discount_percentage" name="discount_percentage" 
                     class="form-control" step="1" min="0" max="100">
            </div>

            <div class="form-group">
              <label>Orden de Visualización</label>
              <input type="number" [(ngModel)]="formData.sort_order" name="sort_order" 
                     class="form-control" step="1" min="0">
            </div>
          </div>

          <!-- Features Section -->
          <div class="features-section">
            <h4>Características</h4>
            
            <div class="feature-group">
              <div class="feature-header">
                <label>Incluidas</label>
                <button type="button" class="btn-sm btn-primary" (click)="addFeature('included')">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <ul class="feature-list" *ngIf="formData.features && formData.features.included && formData.features.included.length > 0">
                <li *ngFor="let feature of formData.features.included; let i = index">
                  {{ feature }}
                  <button type="button" class="btn-icon-sm btn-danger" (click)="removeFeature('included', i)">
                    <i class="fas fa-times"></i>
                  </button>
                </li>
              </ul>
            </div>

            <div class="feature-group">
              <div class="feature-header">
                <label>Excluidas</label>
                <button type="button" class="btn-sm btn-secondary" (click)="addFeature('excluded')">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <ul class="feature-list" *ngIf="formData.features && formData.features.excluded && formData.features.excluded.length > 0">
                <li *ngFor="let feature of formData.features.excluded; let i = index">
                  {{ feature }}
                  <button type="button" class="btn-icon-sm btn-danger" (click)="removeFeature('excluded', i)">
                    <i class="fas fa-times"></i>
                  </button>
                </li>
              </ul>
            </div>
          </div>

          <!-- Display Config -->
          <div class="display-config-section">
            <h4>Configuración de Visualización</h4>
            
            <div class="form-group">
              <label>
                <input type="checkbox" [(ngModel)]="formData.display_config!.highlight" name="highlight">
                Destacar esta variante
              </label>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Etiqueta (Badge)</label>
                <input type="text" [(ngModel)]="formData.display_config!.badge" name="badge" 
                       class="form-control" placeholder="Ej: Más Popular">
              </div>

              <div class="form-group">
                <label>Color</label>
                <input type="color" [(ngModel)]="formData.display_config!.color" name="color" 
                       class="form-control color-input">
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeForm()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="saveVariant()">Guardar</button>
      </div>
    </div>
  </div>
</div>

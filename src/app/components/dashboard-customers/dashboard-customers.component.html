<div class="container-fluid vh-100">
    <div class="row h-100 p-2">
        <div class="col-12 h-100 p-0 d-flex flex-column overflow-hidden">
            
            <!-- Estado del sistema multi-tenant -->
            <div class="alert alert-info mb-3" *ngIf="currentCompany">
                <strong>Empresa actual:</strong> {{currentCompany}}
            </div>
            
            <!-- Tabs para alternar entre vista legacy y nueva -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link" [class.active]="activeTab === 'legacy'" (click)="activeTab = 'legacy'">
                        Clientes Legacy ({{customers.length}})
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" [class.active]="activeTab === 'multitenant'" (click)="activeTab = 'multitenant'">
                        Clientes Multi-Tenant ({{clients.length}})
                    </a>
                </li>
            </ul>

            <!-- Buscador -->
            <div class="input-group mb-3" id="inputCustomersTable">
                <input [(ngModel)]="searchCustomer" 
                       (keyup)="activeTab === 'multitenant' ? searchClients() : null"
                       type="text" 
                       id="buscadorCustomers" 
                       class="form-control" 
                       placeholder="Realiza tus búsquedas aquí">
                
                <!-- Botón para crear nuevo cliente multi-tenant -->
                <button *ngIf="activeTab === 'multitenant'" 
                        class="btn btn-primary" 
                        (click)="createNewClient()">
                    Nuevo Cliente
                </button>
            </div>

            <!-- Loading y errores -->
            <div *ngIf="loading" class="alert alert-info">Cargando...</div>
            <div *ngIf="error" class="alert alert-danger">{{error}}</div>

            <!-- VISTA LEGACY -->
            <div *ngIf="activeTab === 'legacy'">
                <table id="headersTable" class="table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Apellidos</th>
                            <th>DNI</th>
                            <th>Dirección</th>
                            <th>Localidad</th>
                            <th>Teléfono</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                </table>
                <div class="table-responsive rounded" id="containerCustomersTable">
                    <table id="tablaCustomers" class="table table-striped mb-1 rounded">
                        <tbody id="customersBodyTable" class="h-100">
                            <tr *ngFor="let customer of filterCustomers()" class="customer" (click)="openCustomerModal(customer)">
                                <td class="align-content-center">{{customer.nombre}}</td>
                                <td class="align-content-center">{{customer.apellidos}}</td>
                                <td class="align-content-center">{{customer.dni}}</td>
                                <td class="align-content-center">{{customer.direccion?.tipo_via}} {{customer.direccion?.nombre}} {{customer.direccion?.numero}}</td>
                                <td class="align-content-center">{{customer.direccion?.localidad?.nombre}}, {{customer.direccion?.localidad?.CP}}</td>
                                <td class="align-content-center">
                                    <a href="tel:{{customer.telefono}}" (click)="$event.stopPropagation()">{{customer.telefono}}</a>
                                </td>
                                <td class="align-content-center">{{customer.email}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <app-btn-new 
                    itemType="Nuevo Cliente"
                    [totalItems]="customers.length"
                    [maxSteps]="3">
                </app-btn-new>
            </div>

            <!-- VISTA MULTI-TENANT -->
            <div *ngIf="activeTab === 'multitenant'">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Teléfono</th>
                            <th>Creado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                </table>
                <div class="table-responsive rounded">
                    <table class="table table-striped mb-1 rounded">
                        <tbody>
                            <tr *ngFor="let client of clients" class="client-row">
                                <td class="align-content-center">
                                    <small class="text-muted">{{client.id.substring(0, 8)}}...</small>
                                </td>
                                <td class="align-content-center">
                                    <strong>{{client.name}}</strong>
                                </td>
                                <td class="align-content-center">
                                    <a href="mailto:{{client.email}}" *ngIf="client.email">{{client.email}}</a>
                                    <span *ngIf="!client.email" class="text-muted">Sin email</span>
                                </td>
                                <td class="align-content-center">
                                    <a href="tel:{{client.phone}}" *ngIf="client.phone">{{client.phone}}</a>
                                    <span *ngIf="!client.phone" class="text-muted">Sin teléfono</span>
                                </td>
                                <td class="align-content-center">
                                    <small>{{client.created_at | date:'short'}}</small>
                                </td>
                                <td class="align-content-center">
                                    <button class="btn btn-sm btn-outline-danger" 
                                            (click)="deleteClient(client.id)">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                            
                            <!-- Mensaje si no hay clientes -->
                            <tr *ngIf="clients.length === 0 && !loading">
                                <td colspan="6" class="text-center text-muted py-4">
                                    No hay clientes en esta empresa. 
                                    <button class="btn btn-link" (click)="createNewClient()">Crear el primero</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Estadísticas de clientes multi-tenant -->
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5 class="card-title">{{clients.length}}</h5>
                                    <p class="card-text">Total Clientes</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5 class="card-title">{{getClientsWithEmail()}}</h5>
                                    <p class="card-text">Con Email</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5 class="card-title">{{getClientsWithPhone()}}</h5>
                                    <p class="card-text">Con Teléfono</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-success">✓</h5>
                                    <p class="card-text">Multi-Tenant</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal legacy -->
            <app-modal-customer
                *ngIf="selectedCustomer"
                [customer]="selectedCustomer"
                (close)="closeCustomerModal()">
            </app-modal-customer>
        </div>
    </div>
</div>
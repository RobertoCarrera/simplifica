# Security Report - May 23, 2026

## Executive Summary
This audit identified critical vulnerabilities in the Data Layer (RLS) allowing cross-tenant data access, and high-risk backdoors in Edge Functions. Immediate remediation is required for `payment_integrations`, `domains`, and `verifactu-dispatcher`.

## Findings

### 1. [CRITICAL] Cross-Tenant RLS Leaks (IDOR)
**Affected Resources:** `payment_integrations`, `domains`, `scheduled_jobs`, `app_settings`
**Risk:** High. An administrator from one company can access, modify, or delete resources (payment settings, domains, jobs) belonging to *any* other company.
**Root Cause:** RLS policies checks if the user is an 'admin' (`ar.name IN ('admin', ...)`) but fails to verify that the user's `company_id` matches the resource's `company_id`.
**Location:** `supabase/migrations/20260111130000_remove_legacy_role_column.sql`

### 2. [HIGH] Debug Backdoors & IDOR in Edge Functions
**Affected Resource:** `verifactu-dispatcher`
**Risk:** High.
- **Debug Actions:** Hardcoded actions (`debug-env`, `debug-test-update`, `diag`) expose environment variables, internal event data, and allow manipulating retry logic.
- **IDOR in `test-cert`:** The `test-cert` action accepts a `company_id` but does not verify if the caller is authorized for that company, allowing unauthorized certificate testing.
**Location:** `supabase/functions/verifactu-dispatcher/index.ts`

### 3. [HIGH] Fail-Open Webhook Verification
**Affected Resource:** `payment-webhook-stripe`
**Risk:** High.
- **Fail Open:** If the database record for the integration is missing the secret, or if the decryption fails, the signature verification is skipped or uses an empty key, potentially allowing forged requests.
- **Insecure Default:** Uses a fallback `default-dev-key-change-in-prod` for encryption key.
**Location:** `supabase/functions/payment-webhook-stripe/index.ts`

## Remediation Plan (Immediate)

1. **Fix RLS Policies:** Apply a new migration to enforce `company_id` checks on all affected tables.
2. **Harden Edge Functions:** Remove debug actions from `verifactu-dispatcher` and implement strict `requireCompanyAccess` checks.

---
*Generated by Jules (Security Engineer)*

## 2025-01-20 - HTML Injection in Search Highlighting
**Vulnerability:** The `AdvancedSearchService` highlighted matches by simple regex replacement, returning unescaped HTML strings. When bound to `[innerHTML]` in Angular components, this allowed HTML injection if the search input contained valid HTML tags (like `<h1>`, `<b>`), potentially breaking layout or injecting unwanted formatting, although Angular's sanitizer mitigated XSS.
**Learning:** Even when using Angular's sanitization, "HTML Injection" (content spoofing) is possible if we treat user input as trusted HTML. When the intent is to display text with highlighting, we must explicitly escape the text content *before* inserting highlighting tags.
**Prevention:** Use a "split-escape-join" pattern when highlighting matches in text. Split the string by the match, escape the non-matching parts (and matching parts), and then wrap matches in `<mark>`. Never return a string containing user input mixed with HTML tags without escaping the user input first.
## 2026-01-19 - [Angular Sanitization & DOMPurify]
**Vulnerability:** Potential XSS in `TourOverlayComponent` due to binding `innerHTML` to untrusted content without explicit sanitization, although Angular sanitizes by default.
**Learning:** While Angular's `[innerHTML]` is secure by default (stripping scripts), relying on it implicitly can lead to confusion about security posture. The project uses a custom `SafeHtmlPipe` which uses `DOMPurify` to allow specific attributes (like `target`) while maintaining strict security. Using this pipe explicitly signals "this content is trusted because it was sanitized by DOMPurify".
**Prevention:** Always use `SafeHtmlPipe` (wrapping `DOMPurify`) when binding `innerHTML` to dynamic content, even if Angular's default sanitizer might be sufficient, to ensure consistent and configurable sanitization policies across the application.

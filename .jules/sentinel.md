## 2024-05-23 - [High] Fix Stored XSS in Advanced Search
**Vulnerability:** The `AdvancedSearchService` highlighted search terms by directly replacing matches in the raw text and inserting the result into the DOM via `[innerHTML]`. This created a Stored XSS vulnerability if the searchable content (tickets, customers, etc.) contained malicious HTML scripts, as the "plain text" content was not escaped before highlighting.
**Learning:** Highlighting text requires careful handling. Simply injecting HTML tags (like `<mark>`) into a string necessitates that the original string be treated as HTML. If the original string was intended as plain text, it MUST be escaped first. This is a common pitfall when mixing "rich text" features (highlighting) with "plain text" data.
**Prevention:** Always escape the base text before applying HTML formatting for highlighting. Use a pattern like `escape(text).replace(regex, '<mark>$1</mark>')`. Never assume input data is safe, even if it comes from an internal database.

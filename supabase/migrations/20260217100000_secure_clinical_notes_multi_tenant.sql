-- Migration: Secure Clinical Notes with Multi-Tenant RLS & RPC Checks (V2 - Fix Role Column)-- 1. Enable RLS on client_clinical_notes (just to be safe)ALTER TABLE public.client_clinical_notes ENABLE ROW LEVEL SECURITY;-- 2. Drop existing legacy PoliciesDROP POLICY IF EXISTS "Users can view notes for their company clients" ON public.client_clinical_notes;DROP POLICY IF EXISTS "Users can create notes for their company clients" ON public.client_clinical_notes;DROP POLICY IF EXISTS "Users can update their own notes" ON public.client_clinical_notes;DROP POLICY IF EXISTS "Users can delete their own notes" ON public.client_clinical_notes;-- Drop possibly created V1 policies if partial success (unlikely transaction)DROP POLICY IF EXISTS "clinical_notes_select_policy" ON public.client_clinical_notes;DROP POLICY IF EXISTS "clinical_notes_insert_policy" ON public.client_clinical_notes;DROP POLICY IF EXISTS "clinical_notes_update_policy" ON public.client_clinical_notes;DROP POLICY IF EXISTS "clinical_notes_delete_policy" ON public.client_clinical_notes;-- 3. Create New Multi-Tenant Policies using company_members-- SELECT: Active company members can view notes for clients of their companyCREATE POLICY "clinical_notes_select_policy" ON public.client_clinical_notes    FOR SELECT USING (        EXISTS (            SELECT 1 FROM public.clients c            JOIN public.company_members cm ON c.company_id = cm.company_id            WHERE c.id = client_clinical_notes.client_id            AND cm.user_id = auth.uid()            AND cm.status = 'active'        )    );-- INSERT: Active company members can create notes for clients of their companyCREATE POLICY "clinical_notes_insert_policy" ON public.client_clinical_notes    FOR INSERT WITH CHECK (        EXISTS (            SELECT 1 FROM public.clients c            JOIN public.company_members cm ON c.company_id = cm.company_id            WHERE c.id = client_clinical_notes.client_id            AND cm.user_id = auth.uid()            AND cm.status = 'active'        )    );-- UPDATE: Only creator can update their own notes (and must still be active member)CREATE POLICY "clinical_notes_update_policy" ON public.client_clinical_notes    FOR UPDATE USING (        created_by = auth.uid()        AND EXISTS (             SELECT 1 FROM public.clients c             JOIN public.company_members cm ON c.company_id = cm.company_id             WHERE c.id = client_clinical_notes.client_id             AND cm.user_id = auth.uid()             AND cm.status = 'active'        )    );-- DELETE: Only creator or Admin/Owner can delete notes-- Uses app_roles table via role_id since 'role' text column was removedCREATE POLICY "clinical_notes_delete_policy" ON public.client_clinical_notes    FOR DELETE USING (        (created_by = auth.uid())         OR         EXISTS (            SELECT 1 FROM public.clients c            JOIN public.company_members cm ON c.company_id = cm.company_id            JOIN public.app_roles ar ON cm.role_id = ar.id            WHERE c.id = client_clinical_notes.client_id            AND cm.user_id = auth.uid()            AND cm.status = 'active'            AND ar.name IN ('owner', 'admin')        )    );-- 4. Secure RPCs (Security Definer functions need explicit permission checks)CREATE OR REPLACE FUNCTION public.create_clinical_note(p_client_id uuid, p_content text)RETURNS jsonbLANGUAGE plpgsqlSECURITY DEFINERSET search_path = publicAS $$DECLARE    v_note_id uuid;    v_encrypted_content text;    v_encryption_key text;     v_company_id uuid;BEGIN    -- 1. Permission Check: Is the user an active member?    SELECT c.company_id INTO v_company_id    FROM public.clients c    JOIN public.company_members cm ON c.company_id = cm.company_id    WHERE c.id = p_client_id    AND cm.user_id = auth.uid()    AND cm.status = 'active';    IF v_company_id IS NULL THEN        RAISE EXCEPTION 'Access denied: User is not an active member of the client company';    END IF;    v_encryption_key := 'simplifica-secure-key-2026';    -- 3. Encrypt    v_encrypted_content := pgp_sym_encrypt(p_content, v_encryption_key);    -- 4. Insert    INSERT INTO public.client_clinical_notes (client_id, content, created_by)    VALUES (p_client_id, v_encrypted_content, auth.uid())    RETURNING id INTO v_note_id;    RETURN jsonb_build_object(        'id', v_note_id,        'success', true    );END;$$;CREATE OR REPLACE FUNCTION public.get_client_clinical_notes(p_client_id uuid)RETURNS TABLE (    id uuid,    client_id uuid,    content text,    created_at timestamptz,    created_by_name text)LANGUAGE plpgsqlSECURITY DEFINERSET search_path = publicAS $$DECLARE    v_encryption_key text := 'simplifica-secure-key-2026';    v_has_access boolean;BEGIN    -- 1. Permission Check    SELECT EXISTS (        SELECT 1 FROM public.clients c        JOIN public.company_members cm ON c.company_id = cm.company_id        WHERE c.id = p_client_id        AND cm.user_id = auth.uid()        AND cm.status = 'active'    ) INTO v_has_access;    IF NOT v_has_access THEN        RAISE EXCEPTION 'Access denied: User is not an active member of the client company';    END IF;    -- 2. Return Decrypted Data    RETURN QUERY    SELECT         n.id,        n.client_id,        pgp_sym_decrypt(n.content::bytea, v_encryption_key) AS content,        n.created_at,        u.name AS created_by_name    FROM public.client_clinical_notes n    LEFT JOIN public.users u ON n.created_by = u.id
    WHERE n.client_id = p_client_id
    ORDER BY n.created_at DESC;
END;
$$;

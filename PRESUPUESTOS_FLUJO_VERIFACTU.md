# PRESUPUESTOS ‚Üí FACTURAS: Flujo Veri*Factu

## üìå RESUMEN

Este documento explica c√≥mo funciona el sistema de presupuestos y su conversi√≥n a facturas cumpliendo con la normativa **Veri*Factu** de la AEAT.

---

## üîÑ FLUJO COMPLETO

### ETAPA 1: Presupuesto (Quote)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  EMPRESA crea PRESUPUESTO                           ‚îÇ
‚îÇ  ‚îú‚îÄ Cliente: Juan P√©rez                             ‚îÇ
‚îÇ  ‚îú‚îÄ Concepto: Desarrollo web                        ‚îÇ
‚îÇ  ‚îú‚îÄ Importe: 1.000‚Ç¨ + IVA = 1.210‚Ç¨                  ‚îÇ
‚îÇ  ‚îú‚îÄ V√°lido hasta: 2025-11-15                        ‚îÇ
‚îÇ  ‚îî‚îÄ Estado: DRAFT                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  EMPRESA env√≠a a CLIENTE                            ‚îÇ
‚îÇ  ‚îî‚îÄ Estado: SENT                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CLIENTE visualiza presupuesto                      ‚îÇ
‚îÇ  ‚îú‚îÄ URL: /quotes/client/abc-123/token-xyz          ‚îÇ
‚îÇ  ‚îú‚îÄ Tracking: IP, User-Agent, Fecha                ‚îÇ
‚îÇ  ‚îî‚îÄ Estado: VIEWED                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CLIENTE acepta presupuesto                         ‚îÇ
‚îÇ  ‚îú‚îÄ Bot√≥n: "Aceptar Presupuesto"                   ‚îÇ
‚îÇ  ‚îú‚îÄ Fecha aceptaci√≥n guardada                      ‚îÇ
‚îÇ  ‚îî‚îÄ Estado: ACCEPTED ‚úÖ                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### ETAPA 2: Conversi√≥n a Factura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  EMPRESA convierte a FACTURA                        ‚îÇ
‚îÇ  ‚îú‚îÄ Bot√≥n: "Convertir a Factura"                   ‚îÇ
‚îÇ  ‚îî‚îÄ Llama: convertToInvoice(quote_id)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FUNCI√ìN SQL: convert_quote_to_invoice()            ‚îÇ
‚îÇ  ‚îú‚îÄ 1. Valida estado = ACCEPTED                    ‚îÇ
‚îÇ  ‚îú‚îÄ 2. Obtiene serie de factura                    ‚îÇ
‚îÇ  ‚îú‚îÄ 3. Genera n√∫mero: 2025-A-00042                 ‚îÇ
‚îÇ  ‚îú‚îÄ 4. Crea registro en tabla invoices             ‚îÇ
‚îÇ  ‚îú‚îÄ 5. Copia items con precios exactos             ‚îÇ
‚îÇ  ‚îú‚îÄ 6. Actualiza quote: status=INVOICED            ‚îÇ
‚îÇ  ‚îî‚îÄ 7. Guarda invoice_id en quote                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  TRIGGERS AUTOM√ÅTICOS (Factura)                     ‚îÇ
‚îÇ  ‚îú‚îÄ calculate_invoice_totals()                     ‚îÇ
‚îÇ  ‚îú‚îÄ generate_verifactu_hash()                      ‚îÇ
‚îÇ  ‚îî‚îÄ update_invoice_status()                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FACTURA REGISTRADA                                 ‚îÇ
‚îÇ  ‚îú‚îÄ N√∫mero: 2025-A-00042                           ‚îÇ
‚îÇ  ‚îú‚îÄ Hash Veri*Factu: SHA-256(...)                  ‚îÇ
‚îÇ  ‚îú‚îÄ Estado: DRAFT                                   ‚îÇ
‚îÇ  ‚îú‚îÄ Referencia: "Desde presupuesto 2025-Q-00015"  ‚îÇ
‚îÇ  ‚îî‚îÄ Quote: invoice_id = abc-factura-123            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### ETAPA 3: Registro Veri*Factu

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  EMPRESA finaliza FACTURA                           ‚îÇ
‚îÇ  ‚îú‚îÄ Cambia estado: DRAFT ‚Üí SENT                    ‚îÇ
‚îÇ  ‚îî‚îÄ Trigger: generate_verifactu_hash()             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SISTEMA VERI*FACTU                                 ‚îÇ
‚îÇ  ‚îú‚îÄ Hash SHA-256 calculado                         ‚îÇ
‚îÇ  ‚îú‚îÄ Blockchain: hash anterior + datos              ‚îÇ
‚îÇ  ‚îú‚îÄ QR generado: Base64 del XML                    ‚îÇ
‚îÇ  ‚îú‚îÄ XML estructurado (formato AEAT)                ‚îÇ
‚îÇ  ‚îî‚îÄ ‚è≥ Firma digital (pendiente certificado)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FACTURA REGISTRADA EN BLOCKCHAIN                   ‚îÇ
‚îÇ  ‚îú‚îÄ Inmutable                                       ‚îÇ
‚îÇ  ‚îú‚îÄ Verificable                                     ‚îÇ
‚îÇ  ‚îú‚îÄ Auditable                                       ‚îÇ
‚îÇ  ‚îî‚îÄ Cumple Veri*Factu ‚úÖ                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚öñÔ∏è MARCO LEGAL

### ¬øPor qu√© presupuestos NO van a Veri*Factu?

**Veri*Factu** es un sistema de **verificaci√≥n de facturas** (Real Decreto 1007/2023).

- ‚úÖ **Facturas**: Documentos fiscales obligatorios ‚Üí **S√ç se registran**
- ‚ùå **Presupuestos**: Documentos comerciales previos ‚Üí **NO se registran**
- ‚úÖ **Conversi√≥n**: Presupuesto aceptado ‚Üí Factura ‚Üí **Entonces S√ç se registra**

### Normativa aplicable

| Documento | Normativa | Obligaci√≥n |
|-----------|-----------|------------|
| Presupuesto | C√≥digo de Comercio | Conservar 6 a√±os |
| Factura | Ley General Tributaria | Conservar 4 a√±os + Veri*Factu |
| Datos personales | GDPR | Anonimizar tras 7 a√±os |

---

## üîê INTEGRIDAD DE DATOS

### Garant√≠as del sistema

1. **Trazabilidad completa**
   - Quote ID ‚Üí Invoice ID (bidireccional)
   - Historial de estados
   - Auditor√≠a de cambios

2. **Inmutabilidad**
   - Presupuesto aceptado ‚Üí No se puede editar
   - Factura generada ‚Üí Enlazada permanentemente
   - Items copiados ‚Üí Precios congelados

3. **Verificaci√≥n**
   - Hash Veri*Factu ‚Üí Blockchain
   - QR code ‚Üí Verificaci√≥n cliente
   - Firma digital ‚Üí Autenticidad (futuro)

---

## üí° CASOS DE USO

### Caso 1: Cliente acepta presupuesto

```typescript
// 1. Cliente ve presupuesto p√∫blico
GET /quotes/client/abc-123/token-xyz

// 2. Sistema registra visualizaci√≥n
quotesService.markQuoteAsViewed(id, ip, userAgent);

// 3. Cliente acepta
quotesService.acceptQuote(id);

// 4. Empresa convierte
quotesService.convertToInvoice(quoteId).subscribe(result => {
  console.log('Factura creada:', result.invoice_id);
  // Resultado: { invoice_id: '...', success: true }
});

// 5. Factura entra en Veri*Factu autom√°ticamente
```

### Caso 2: Presupuesto expira

```typescript
// Job diario (cron)
quotesService.markExpiredQuotes().subscribe(count => {
  console.log(`${count} presupuestos marcados como expirados`);
});

// SQL autom√°tico
UPDATE quotes
SET status = 'expired'
WHERE status IN ('draft', 'sent', 'viewed')
  AND valid_until < CURRENT_DATE;
```

### Caso 3: Cliente rechaza

```typescript
// Cliente rechaza presupuesto
quotesService.rejectQuote(id);

// Quote status: REJECTED
// No se puede convertir a factura
// Se conserva para hist√≥rico
```

---

## üìä DATOS CONSERVADOS

### En el Presupuesto (Quote)

```sql
SELECT 
  full_quote_number,        -- 2025-Q-00015
  client_id,                -- Referencia cliente
  status,                   -- INVOICED
  accepted_at,              -- 2025-10-20T10:30:00Z
  invoice_id,               -- abc-factura-123
  total_amount,             -- 1210.00
  retention_until           -- 2032-10-15 (7 a√±os)
FROM quotes
WHERE id = 'abc-quote-123';
```

### En la Factura (Invoice)

```sql
SELECT 
  full_invoice_number,      -- 2025-A-00042
  client_id,                -- Mismo cliente
  notes,                    -- "Generada desde presupuesto 2025-Q-00015"
  total_amount,             -- 1210.00 (mismo importe)
  verifactu_hash,           -- SHA-256(...)
  verifactu_qr_code,        -- Base64(...)
  created_at                -- 2025-10-20T10:35:00Z
FROM invoices
WHERE id = 'abc-factura-123';
```

### En los Items

**Quote Items** (Presupuesto):
```sql
SELECT description, quantity, unit_price, tax_rate, total
FROM quote_items
WHERE quote_id = 'abc-quote-123';
```

**Invoice Items** (Factura):
```sql
SELECT description, quantity, unit_price, tax_rate, total
FROM invoice_items
WHERE invoice_id = 'abc-factura-123';
```

**Resultado**: Items id√©nticos, precios congelados ‚úÖ

---

## üö® VALIDACIONES

### Al convertir presupuesto

```typescript
// Funci√≥n SQL: convert_quote_to_invoice()

// ‚ùå ERROR: Estado incorrecto
IF v_quote.status != 'accepted' THEN
  RAISE EXCEPTION 'Solo se pueden convertir presupuestos aceptados';
END IF;

// ‚ùå ERROR: Ya convertido
IF v_quote.invoice_id IS NOT NULL THEN
  RAISE EXCEPTION 'Este presupuesto ya fue convertido a factura';
END IF;

// ‚ùå ERROR: Sin serie de factura
IF p_invoice_series_id IS NULL THEN
  RAISE EXCEPTION 'No hay serie de factura por defecto configurada';
END IF;

// ‚úÖ OK: Proceder a crear factura
```

### En el frontend

```typescript
canConvertToInvoice(quote: Quote): boolean {
  return quote.status === QuoteStatus.ACCEPTED && !quote.invoice_id;
}

// UI: Bot√≥n deshabilitado si no cumple condiciones
```

---

## üîÑ ESTADOS Y TRANSICIONES

### Diagrama de estados

```
DRAFT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> SENT
  ‚îÇ                             ‚îÇ
  ‚îÇ                             ‚ñº
  ‚îÇ                          VIEWED
  ‚îÇ                             ‚îÇ
  ‚îÇ                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                      ‚ñº             ‚ñº
  ‚ñº                   ACCEPTED      REJECTED
CANCELLED               ‚îÇ             ‚îÇ
                        ‚ñº             ‚îÇ
                    INVOICED          ‚îÇ
                                      ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚ñº
                 EXPIRED
```

### Reglas de transici√≥n

| Desde | Hacia | Acci√≥n | Reversible |
|-------|-------|--------|------------|
| DRAFT | SENT | `sendQuote()` | ‚ùå |
| SENT | VIEWED | `markQuoteAsViewed()` | ‚ùå |
| VIEWED | ACCEPTED | `acceptQuote()` | ‚ùå |
| VIEWED | REJECTED | `rejectQuote()` | ‚ùå |
| ACCEPTED | INVOICED | `convertToInvoice()` | ‚ùå |
| * | CANCELLED | Usuario cancela | ‚ùå |
| DRAFT/SENT/VIEWED | EXPIRED | Job autom√°tico | ‚ùå |

**Importante**: ‚ùå Ninguna transici√≥n es reversible (inmutabilidad)

---

## üì± VISTA P√öBLICA PARA CLIENTES

### URL compartible

```
https://tuapp.com/quotes/client/{quote_id}/{security_token}
```

**Caracter√≠sticas**:
- ‚úÖ No requiere login
- ‚úÖ Token de seguridad √∫nico
- ‚úÖ Branding de tu empresa
- ‚úÖ Botones: Aceptar / Rechazar
- ‚úÖ Tracking autom√°tico
- ‚úÖ Responsive (mobile-friendly)

### Implementaci√≥n

```typescript
@Component({
  selector: 'app-quote-client-view',
  template: `
    <div class="public-quote">
      <img [src]="company.logo_url" />
      <h1>Presupuesto {{ quote.full_quote_number }}</h1>
      
      <div class="quote-details">
        <!-- Items, totales, condiciones -->
      </div>

      @if (canAccept()) {
        <div class="actions">
          <button (click)="accept()">‚úÖ Aceptar Presupuesto</button>
          <button (click)="reject()">‚ùå Rechazar</button>
        </div>
      }

      @if (quote.status === 'accepted') {
        <div class="success">
          ‚úÖ Presupuesto aceptado el {{ quote.accepted_at }}
        </div>
      }
    </div>
  `
})
export class QuoteClientViewComponent {
  // Carga quote sin autenticaci√≥n
  // Valida token de seguridad
  // Permite aceptar/rechazar
}
```

---

## üéØ VENTAJAS DEL SISTEMA

### Para la Empresa

- ‚úÖ **Automatizaci√≥n**: Conversi√≥n autom√°tica presupuesto ‚Üí factura
- ‚úÖ **Cumplimiento**: Veri*Factu autom√°tico en facturas
- ‚úÖ **Trazabilidad**: Historial completo del proceso
- ‚úÖ **Eficiencia**: No duplicar datos, copiar de presupuesto
- ‚úÖ **Legal**: Cumple GDPR y normativa fiscal

### Para el Cliente

- ‚úÖ **Transparencia**: Ve presupuesto profesional
- ‚úÖ **Facilidad**: Aceptar/rechazar con un clic
- ‚úÖ **Seguridad**: URL con token √∫nico
- ‚úÖ **Mobile**: Funciona en cualquier dispositivo
- ‚úÖ **Confianza**: Branding de empresa conocida

### Para Auditor√≠as

- ‚úÖ **Inmutable**: No se pueden alterar datos
- ‚úÖ **Verificable**: Hash blockchain Veri*Factu
- ‚úÖ **Completo**: Todos los estados registrados
- ‚úÖ **Conforme**: Cumple todas las normativas

---

## üîÆ PR√ìXIMAS FUNCIONALIDADES

1. **Generaci√≥n autom√°tica de PDF**
   - Plantillas personalizables
   - Logo y branding
   - Env√≠o por email

2. **Notificaciones**
   - Email cuando cliente ve presupuesto
   - Email cuando acepta/rechaza
   - Recordatorio de expiraci√≥n

3. **Plantillas**
   - Presupuestos predefinidos
   - Items recurrentes
   - T√©rminos y condiciones

4. **Estad√≠sticas**
   - Tasa de aceptaci√≥n
   - Tiempo medio de respuesta
   - Valor medio de presupuestos

---

## ‚úÖ CHECKLIST IMPLEMENTACI√ìN

- [x] SQL migraci√≥n ejecutada
- [x] Modelos TypeScript creados
- [x] Servicio Angular creado
- [ ] Componente lista implementado
- [ ] Componente formulario implementado
- [ ] Componente vista cliente implementado
- [ ] Routing configurado
- [ ] Prueba crear presupuesto
- [ ] Prueba conversi√≥n a factura
- [ ] Verificar hash Veri*Factu

---

**Fecha**: 2025-10-15  
**Sistema**: Presupuestos ‚Üí Facturas con Veri*Factu  
**Estado**: ‚úÖ Backend completo, UI en progreso

